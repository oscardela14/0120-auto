import React, { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    ArrowLeft, Sparkles, Wand2, Zap, Save, Copy,
    Share2, Trash2, CheckCircle2, AlertCircle,
    Info, ExternalLink, Hash, Type, PenTool,
    Loader, Palette, UserCog, Bot, RefreshCcw, Layout,
    ChevronRight, Play, BookOpen, MessageCircle,
    BarChart3, Film, Signal, Split, Trophy, Search, Clock, Globe, Crown, ShoppingBag, Coins, Target, TrendingUp, ShieldAlert, Eye, Scissors, Sword, X, ArrowUpRight, Rocket, Building2, ArrowDown,
    Youtube, Instagram, FileText, CreditCard, ArrowRight, Users, Activity, PieChart, Image as ImageIcon
} from 'lucide-react';
import { useUser } from '../contexts/UserContext';
import { PreviewModal } from './PreviewModal';
import { StyleRemix } from './StyleRemix';
import { VisualAudition } from './VisualAudition';
import { ViralSimulator } from './ViralSimulator';
import { NeuralVideoPlayer } from './NeuralVideoPlayer';
import { remixStyle } from '../utils/styleRemix';
import { humanizeText } from '../utils/humanizeEngine';
import { getProductSuggestions, getRevenueProjection } from '../utils/coupangAPI';
import { getEvolutionData, logPerformance } from '../utils/evolutionEngine';
import { convertToPlatform } from '../utils/osmuConverter';
import { cn } from '../lib/utils';
import { matchAffiliateProducts, generateNativeBridge, calculateLTV, determineNiche } from '../utils/revenueEngine';
import { renderVideoV1, getAvailableVoices } from '../utils/videoEngine';
import { PERSONAS } from '../utils/contentGenerator';
import { getKeywordMetadata, calculateExpectedRevenue } from '../utils/naverAdEngine';

const Tooltip = ({ text, children, position = 'bottom' }) => (
    <div className="group relative">
        {children}
        <div className={cn(
            "absolute w-[280px] sm:w-80 p-5 bg-[#0b0e14]/98 border border-white/20 rounded-2xl text-[13px] text-gray-200 leading-relaxed shadow-[0_25px_70px_rgba(0,0,0,0.8)] opacity-0 group-hover:opacity-100 pointer-events-none transition-all duration-300 z-[110] backdrop-blur-3xl",
            position === 'top' && "bottom-full left-1/2 -translate-x-1/2 mb-3 translate-y-2 group-hover:translate-y-0",
            position === 'bottom' && "top-full left-1/2 -translate-x-1/2 mt-3 translate-y-[-8px] group-hover:translate-y-0",
            position === 'bottom-right' && "top-full right-0 mt-3 translate-y-[-8px] group-hover:translate-y-0",
            position === 'left' && "right-full top-1/2 -translate-y-1/2 mr-3 translate-x-2 group-hover:translate-x-0",
            position === 'right' && "left-full top-1/2 -translate-y-1/2 ml-3 -translate-x-2 group-hover:translate-x-0"
        )}>
            <div className={cn(
                "absolute border-8 border-transparent",
                position === 'top' && "top-full left-1/2 -translate-x-1/2 border-t-[#0b0e14]",
                position === 'bottom' && "bottom-full left-1/2 -translate-x-1/2 border-b-[#0b0e14]",
                position === 'bottom-right' && "bottom-full right-6 border-b-[#0b0e14]",
                position === 'left' && "left-full top-1/2 -translate-y-1/2 border-l-[#0b0e14]",
                position === 'right' && "right-full top-1/2 -translate-y-1/2 border-r-[#0b0e14]"
            )} />
            <div className="font-black text-indigo-400 mb-2 flex items-center gap-2 uppercase tracking-widest text-[10px]">
                <Sparkles size={12} className="fill-indigo-400" />
                Expert Insight
            </div>
            <div className="whitespace-normal break-keep font-medium">
                {text}
            </div>
        </div>
    </div>
);

const BrandLogos = {
    MASTER: (props) => (
        <svg viewBox="0 0 24 24" fill="none" className={cn("w-full h-full drop-shadow-md", props.className)} {...props}>
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="#F59E0B" stroke="#F59E0B" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
        </svg>
    ),
    YOUTUBE: (props) => (
        <svg viewBox="0 0 24 24" fill="none" className={cn("w-full h-full drop-shadow-md", props.className)} {...props}>
            <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.33 29 29 0 0 0-.46-5.33z" fill="#FF0000" />
            <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02" fill="white" />
        </svg>
    ),
    INSTAGRAM: (props) => (
        <svg viewBox="0 0 100 100" fill="none" className={cn("w-full h-full drop-shadow-md", props.className)} {...props}>
            <defs>
                <linearGradient id="insta_grad" x1="0" y1="100" x2="100" y2="0" gradientUnits="userSpaceOnUse">
                    <stop offset="0" stopColor="#FFC107" />
                    <stop offset="0.4" stopColor="#F44336" />
                    <stop offset="1" stopColor="#9C27B0" />
                </linearGradient>
            </defs>
            <rect x="10" y="10" width="80" height="80" rx="20" ry="20" stroke="url(#insta_grad)" strokeWidth="8" fill="none" />
            <circle cx="50" cy="50" r="15" stroke="url(#insta_grad)" strokeWidth="8" fill="none" />
            <circle cx="78" cy="22" r="5" fill="url(#insta_grad)" />
        </svg>
    ),
    NAVER: (props) => (
        <svg viewBox="0 0 24 24" fill="none" className={cn("w-full h-full drop-shadow-md", props.className)} {...props}>
            <rect width="24" height="24" rx="4" fill="#03C75A" />
            <path d="M5 5V19H10V12L14 19H19V5H14V12L10 5H5Z" fill="white" />
        </svg>
    ),
    THREADS: (props) => (
        <svg viewBox="0 0 192 192" fill="none" className={cn("w-full h-full drop-shadow-md", props.className)} {...props}>
            <path d="M141.537 88.9883C140.71 88.5919 139.87 88.2104 139.019 87.8451C137.537 60.5382 122.616 44.905 97.5619 44.745C97.4484 44.7443 97.3355 44.7443 97.222 44.7443C82.2364 44.7443 69.7731 51.1409 62.102 62.7807L75.881 72.2328C81.6116 63.5383 90.6052 61.6848 97.2286 61.6848C97.3051 61.6848 97.3819 61.6848 97.4576 61.6855C105.707 61.7381 111.932 64.1366 115.961 68.814C118.893 72.2193 120.854 76.925 121.825 82.8638C114.511 81.6207 106.601 81.2385 98.145 81.7233C74.3247 83.0954 59.0111 96.9879 60.0396 116.292C60.5615 126.084 65.4397 134.508 73.775 140.011C80.8224 144.663 89.899 146.938 99.3323 146.423C111.79 145.74 121.563 140.987 128.381 132.296C133.559 125.696 136.834 117.143 138.28 106.366C144.217 109.949 148.617 114.664 151.047 120.332C155.179 129.967 155.42 145.8 142.501 158.708C131.182 170.016 117.576 174.908 97.0135 175.059C74.2042 174.89 56.9538 167.575 45.7381 153.317C35.2355 139.966 29.8077 120.682 29.6052 96C29.8077 71.3178 35.2355 52.0336 45.7381 38.6827C56.9538 24.4249 74.2039 17.11 97.0132 16.9405C119.988 17.1113 137.539 24.4614 149.184 38.788C154.894 45.8136 159.199 54.6488 162.037 64.9503L178.184 60.6422C174.744 47.9622 169.331 37.0357 161.965 27.974C147.036 9.60668 125.202 0.195148 97.0695 0H96.9569C68.8816 0.19447 47.2921 9.6418 32.7883 28.0793C19.8819 44.4864 13.2244 67.3157 13.0007 95.9325L13 96L13.0007 96.0675C13.2244 124.684 19.8819 147.514 32.7883 163.921C47.2921 182.358 68.8816 191.806 96.9569 192H97.0695C122.03 191.827 139.624 185.292 154.118 170.811C173.081 151.866 172.51 128.119 166.26 113.541C161.776 103.087 153.227 94.5962 141.537 88.9883ZM98.4405 129.507C88.0005 130.095 77.1544 125.409 76.6196 115.372C76.2232 107.93 81.9158 99.626 99.0812 98.6368C101.047 98.5234 102.976 98.468 104.871 98.468C111.106 98.468 116.939 99.0737 122.242 100.233C120.264 124.935 108.662 128.946 98.4405 129.507Z" fill="white" />
        </svg>
    )
};

const ContentCard = ({ children, className = "" }) => (
    <div className={`bg-surface/30 rounded-[28px] p-6 lg:p-10 ${className}`}>
        {children}
    </div>
);

export const ResultView = ({ data, onBack }) => {
    const {
        user,
        addNotification,
        setActiveResult,
        addMonitoringTarget,
        monitoringTargets,
        addToHistory,
        activePlatform,
        setActivePlatform
    } = useUser();
    const navigate = useNavigate();

    // [EXISTING] Single-platform mode states and logic
    const [finalData, setFinalData] = useState(data || {});
    const [selectedPersona, setSelectedPersona] = useState(data?.persona || 'witty');
    const [activeVariant, setActiveVariant] = useState('A');
    const [isHumanizing, setIsHumanizing] = useState(false);
    const [isFactChecking, setIsFactChecking] = useState(false);
    const [isGenerating, setIsGenerating] = useState(false);
    const [showPreview, setShowPreview] = useState(false);
    const [isSaving, setIsSaving] = useState(false);
    const [showDetailedStats, setShowDetailedStats] = useState(false);
    const [showSeoDetails, setShowSeoDetails] = useState(false);
    const [affiliateProducts, setAffiliateProducts] = useState([]);
    const [roiProjection, setRoiProjection] = useState(null);
    const [evolution, setEvolution] = useState(getEvolutionData());
    const [showGapAnalysis, setShowGapAnalysis] = useState(false);
    const [isAnalyzingGap, setIsAnalyzingGap] = useState(false);
    const [assetValuation, setAssetValuation] = useState(null);
    const [isRenderingVideo, setIsRenderingVideo] = useState(false);
    const [renderedVideo, setRenderedVideo] = useState(null);
    const [naverData, setNaverData] = useState(null);
    const [isNaverLoading, setIsNaverLoading] = useState(false);
    const [showWarGame, setShowWarGame] = useState(false);
    const [warGameStatus, setWarGameStatus] = useState('IDLE'); // IDLE, ANALYZING, VOTING, DONE
    const [warGameResult, setWarGameResult] = useState(null);
    const [isAutoPilotActive, setIsAutoPilotActive] = useState(false);
    const [isTurboMode, setIsTurboMode] = useState(false);
    const [activePlatformTab, setActivePlatformTab] = useState('MASTER'); // MASTER, YOUTUBE, INSTAGRAM, NAVER, THREADS
    const [platformContents, setPlatformContents] = useState({
        MASTER: data,
        YOUTUBE: null,
        INSTAGRAM: null,
        NAVER: null,
        THREADS: null
    });
    const [activeGuide, setActiveGuide] = useState(null);
    const [isProcessingTurbo, setIsProcessingTurbo] = useState(false);
    const [showVisualAudition, setShowVisualAudition] = useState(false);
    const [showSimulator, setShowSimulator] = useState(false);
    const [showVideoPlayer, setShowVideoPlayer] = useState(false);

    // Dynamic Platform Content Generator (Missing Function Restored)


    // Calculate Asset Valuation (LTV)
    useEffect(() => {
        if (finalData.topic && roiProjection) {
            const niche = determineNiche(finalData.topic);
            const ltv = calculateLTV({
                views: naverData ? (naverData.monthlyPcQryCnt + naverData.monthlyMobileQryCnt) / 30 : 5000,
                engagementRate: finalData.variants?.[activeVariant]?.analysis?.total / 10 || 5
            }, niche);
            setAssetValuation(ltv);
        }
    }, [finalData.topic, roiProjection, activeVariant, naverData]);

    // Fetch Real-time Naver AD Market Data
    useEffect(() => {
        const fetchNaverMarketData = async () => {
            if (!finalData.topic) return;
            setIsNaverLoading(true);
            try {
                const metadata = await getKeywordMetadata(finalData.topic);
                setNaverData(metadata);
                const revenue = calculateExpectedRevenue(metadata);
                setRoiProjection(prev => ({ ...prev, ...revenue, expectedRevenue: revenue.monthly.toLocaleString() }));
            } catch (e) {
                console.error("Naver Ad Sync failed", e);
            } finally {
                setIsNaverLoading(false);
            }
        };
        fetchNaverMarketData();
    }, [finalData.topic]);

    const runWarGame = async () => {
        setWarGameStatus('ANALYZING');
        setShowWarGame(true);
        addNotification("?ÅÏßÑ Î∂ÑÏÑù Î∂Ä?Ä Í∞Ä??.. ?ÅÏúÑ 1% ÏΩòÌÖêÏ∏†Ï???ÍµêÏ†Ñ??Ï§ÄÎπÑÌï©?àÎã§.", "info");

        await new Promise(r => setTimeout(r, 2000));
        setWarGameStatus('VOTING');
        addNotification("?êÏù¥?ÑÌä∏ 30?∏Ïùò ?§ÏãúÍ∞??¨ÌëúÍ∞Ä ?úÏûë?òÏóà?µÎãà??", "warning");

        await new Promise(r => setTimeout(r, 3000));
        setWarGameStatus('DONE');
        const winProbability = Math.floor(Math.random() * 30) + 65; // 65-95%
        setWarGameResult({
            winProb: winProbability,
            votes: { user: Math.floor(30 * (winProbability / 100)), competitor: 30 - Math.floor(30 * (winProbability / 100)) },
            feedback: "?¨Ïö©?êÎãò??Î¶¨Îìú Î∞©Ïãù???ïÎèÑ?ÅÏúºÎ°??†ÏÑ†?òÎÇò, 3Î≤?Î¨∏Îã®??'Í∑ºÍ±∞ ?úÏãú' Î∂ÄÎ∂ÑÏù¥ Í≤ΩÏüÅ???ÄÎπ??ΩÍ∞Ñ Î∂ÄÏ°±Ìï©?àÎã§. ?êÎèô ?òÏ†ï Î≤ÑÌäº???åÎü¨ Î≥¥Ï∂©?òÏÑ∏??",
            gapScore: 92
        });
        addNotification("?åÍ≤å???úÎ??àÏù¥??Ï¢ÖÎ£å. Í≤∞Í≥ºÎ•??ïÏù∏?òÏÑ∏??", "success");
    };

    const getTotalCharCount = () => {
        const variant = finalData.variants?.[activeVariant];
        if (!variant) return 0;
        const titleLen = (variant.title || "").length;
        const sections = variant.sections || [];
        const contentLen = sections.reduce((acc, s) => {
            const body = s.content || s.text || "";
            return acc + (typeof body === 'string' ? body.length : 0);
        }, 0);
        return titleLen + contentLen;
    };

    // --- Advanced SEO & Strategic Analysis Engine ---
    const calculateDetailedAnalysis = (title, sections, platformType, isViral) => {
        // Safety check for calculation
        if (!finalData?.topic) return { spread: 0, structure: 0, trend: 0, total: 0 };

        if (!sections || !Array.isArray(sections)) return { spread: 0, structure: 0, trend: 0, total: 0 };

        const contentStr = sections.map(s => (s?.content || s?.text || "")).join(' ');
        const charCount = contentStr.length;
        // Use finalData.topic which is always synced
        const actualTopic = finalData?.topic || "";
        const topicRegex = new RegExp(actualTopic.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        const keywordMatches = actualTopic ? (contentStr.match(topicRegex) || []).length : 0;


        let spreadScore = 15;
        if (isViral) spreadScore += 10;
        if (title && /[!??î•?ö®]/.test(title)) spreadScore += 10;
        if (charCount > 500) spreadScore += 10;
        if (charCount > 1200) spreadScore += 5;
        if (charCount < 200) spreadScore -= 10;
        spreadScore = Math.max(5, Math.min(spreadScore, 50));

        let structScore = 0;
        if (charCount < 100) structScore = 5;
        else if (charCount < 500) structScore = 15;
        else if (charCount < 1200) structScore = 25;
        else structScore = 30;

        if (sections.length >= 3) structScore += 5;
        structScore = Math.min(structScore, 30);

        let trendScore = 0;
        const isBlog = platformType?.includes('Blog');
        const isShortVideo = platformType?.includes('Shorts') || platformType?.includes('Reels');

        if (isBlog) {
            if (charCount > 1500) trendScore = 20;
            else if (charCount > 800) trendScore = 12;
            else trendScore = 3;
        } else if (isShortVideo) {
            if (charCount > 100 && charCount < 600) trendScore = 20;
            else trendScore = 8;
        }

        if (keywordMatches > 3) trendScore += 5;
        trendScore = Math.min(trendScore, 20);

        const total = spreadScore + structScore + trendScore;

        return {
            total: Math.min(Math.max(total, 10), 99),
            spread: spreadScore,
            structure: structScore,
            trend: trendScore,
            charCount: charCount,
            keywordCount: keywordMatches,
            pros: charCount < 300 ? '?¥Ïö© Î≥¥Í∞ï???úÍ∏â???îÏïΩ?? : (isViral ? 'Ï¥àÍ∏∞ ?†ÏûÖ??Í∞ïÎ†•???§Ì??? : '?ïÎ≥¥???†Î¢∞?±Ïù¥ ?íÏ? ?ÑÎ¨∏??),
            tip: charCount < 500 ? 'Î≥∏Î¨∏ Î∂ÑÎüâ??1,000???¥ÏÉÅ?ºÎ°ú ?òÎ¶¨?∏Ïöî. ?ÑÏû¨??"?Ä?àÏßà" ?ÑÌóòÍµ∞ÏûÖ?àÎã§.' : '?úÎ™©??ÏßÄ??™Ö?¥ÎÇò Íµ¨Ï≤¥?ÅÏù∏ ?òÏπòÎ•?Ï∂îÍ??òÎ©¥ ?†ÏûÖÎ•†Ïù¥ ???¨ÎùºÍ∞ëÎãà??'
        };
    };

    // Initial variant setup if not present
    useEffect(() => {
        if (!finalData.variants && finalData.topic) {
            setFinalData(prev => {
                const topic = prev.topic || "ÏΩòÌÖêÏ∏?;
                const platform = prev.platform || "MASTER";

                const titleA = prev.title || `?î• [?ïÎ≥¥ Í≥µÏú†] ${topic} Í¥Ä??ÍøÄ???ÄÎ∞©Ï∂ú!`;
                const titleB = prev.titleB || `?ö® ?îÏßÅ??${topic}, ?¥Í±∞ Î™®Î•¥Î©??êÌï¥ ?ÑÎãåÍ∞Ä?? (ÎπÑÎ? Í≥µÍ∞ú)`;

                let sectionsA = prev.sections;
                if (!sectionsA || !Array.isArray(sectionsA) || sectionsA.length === 0) {
                    if (prev.script && Array.isArray(prev.script)) {
                        sectionsA = prev.script;
                    } else if (prev.content) {
                        sectionsA = [{ title: 'Î≥∏Î°†', content: prev.content }];
                    } else {
                        sectionsA = [{ title: 'Î≥∏Î°†', content: "" }];
                    }
                }

                let sectionsB = prev.sectionsB || [];
                if (!sectionsB || !Array.isArray(sectionsB) || sectionsB.length === 0) {
                    if (prev.scriptB && Array.isArray(prev.scriptB)) {
                        sectionsB = prev.scriptB;
                    } else {
                        sectionsB = sectionsA.map(s => ({
                            ...s,
                            title: s.title === 'Î≥∏Î°†' ? '?î• ?µÏã¨ ÎπÑÎ≤ï' : s.title,
                            content: (s.content || s.text || "")
                        }));
                    }
                }

                const analysisA = calculateDetailedAnalysis(titleA, sectionsA, platform, false);
                const analysisB = calculateDetailedAnalysis(titleB, sectionsB, platform, true);

                const ctrA = Math.round(analysisA.total * 0.04 + (titleA.length % 3)) + '%';
                const ctrB = Math.round(analysisB.total * 0.08 + (titleB.length % 4) + 1.2) + '%';

                return {
                    ...prev,
                    variants: {
                        A: {
                            id: 'A',
                            strategy: '?ïÎ≥¥??& ?ïÎ≥¥ ?ÑÎã¨??,
                            title: titleA,
                            sections: sectionsA,
                            ctr: ctrA,
                            score: analysisA.total,
                            analysis: analysisA
                        },
                        B: {
                            id: 'B',
                            strategy: '?êÍ∑π??& ?¥Î¶≠ ?†ÎèÑ??,
                            title: titleB,
                            sections: sectionsB,
                            ctr: ctrB,
                            score: analysisB.total,
                            analysis: analysisB,
                            winner: parseFloat(ctrB) > parseFloat(ctrA)
                        }
                    }
                };
            });
        }
    }, [finalData?.topic, finalData?.platform]);

    // Fetch Affiliate Suggestions
    useEffect(() => {
        if (finalData.topic) {
            const fetchAffiliates = async () => {
                const products = await getProductSuggestions(finalData.topic);
                setAffiliateProducts(products);

                // Calculate projected ROI based on 5000 views (avg)
                const projection = getRevenueProjection(5000);
                setRoiProjection(projection);
            };
            fetchAffiliates();
        }
    }, [finalData.topic]);

    // Sync context (Debounced to prevent Jitter/Shaking during typing)
    useEffect(() => {
        const timer = setTimeout(() => {
            setActiveResult(finalData);
        }, 500);
        return () => clearTimeout(timer);
    }, [finalData, setActiveResult]);

    const handlePersonaChange = (personaId) => {
        setSelectedPersona(personaId);
        addNotification(`${personaId} ?òÎ•¥?åÎÇò ?§Ì??ºÏùÑ Î∂ÑÏÑù?òÏó¨ Î¨∏Ï≤¥??Î∞òÏòÅ?©Îãà??`, 'info');

        // Simulate AI processing for style transformation
        setTimeout(() => {
            setFinalData(prev => {
                const updatedVariants = { ...prev.variants };
                const variant = updatedVariants[activeVariant];

                if (variant) {
                    const transformStyle = (text) => {
                        if (!text || typeof text !== 'string') return text;
                        let transformed = text;

                        if (personaId === 'witty') {
                            // ?¥Î? Î≥Ä??Î∞??¥Î™®ÏßÄ Ï∂îÍ?
                            transformed = transformed
                                .replace(/?àÎã§\./g, '?àÏöî! ?î•')
                                .replace(/?µÎãà??./g, '?§Ïöî ?ã„Öã ??)
                                .replace(/?¥Ïöî\./g, '?úÎã§Íµ¨Ïöî! ?ëç')
                                .replace(/?ÖÎãà??./g, '????öî! ?òÆ')
                                .replace(/Ï§ëÏöî?©Îãà??g, '?¥Í±¥ ?àÏïå ?ÑÏàò?úÏù¥Ï£?)
                                .replace(/Îß§Ïö∞/g, 'ÏßÑÏßú ?ÑÏ†Ñ')
                                .replace(/Ï∂îÏ≤ú?©Îãà??g, '???∞Î©¥ ?êÌï¥! Í∞ïÎ†• Ï∂îÏ≤ú Í∞ÄÏ¶àÏïÑ~');
                        } else if (personaId === 'professional') {
                            // Î¨∏Ïñ¥Ï≤?Î∞??ÑÎ¨∏ ?©Ïñ¥ ?êÎÇå???¥Î?
                            transformed = transformed
                                .replace(/[?îÏ£†]!/g, '??')
                                .replace(/!!/g, '.')
                                .replace(/?§Ïöî/g, '?µÎãà??)
                                .replace(/?¥Ïöî/g, '?©Îãà??)
                                .replace(/[?é„Öé?ã„Öã?®üî•üëçüò?/g, '') // ?¥Î™®ÏßÄ ?úÍ±∞
                                .replace(/ÏßÑÏßú|?òÍ≤å|?ÑÏ†Ñ/g, '?ÅÎãπ??)
                                .replace(/Î∞©Î≤ï/g, '?ÑÎûµ??Î©îÏª§?àÏ¶ò')
                                .replace(/Ï§ÄÎπÑÌñà?µÎãà??g, '?¨ÎèÑ ?àÍ≤å Î∂ÑÏÑù?òÏó¨ ?úÏãú?òÍ≥†???©Îãà??);
                        } else if (personaId === 'empathetic') {
                            // ?∞Îúª?òÍ≥† Í≥µÍ∞ê?ÅÏù∏ ÎßêÌà¨
                            transformed = transformed
                                .replace(/??./g, '?§Ïöî.. ÎßàÏùå???ÑÌï¥ÏßÄÍ∏?Î∞îÎùº???íñ')
                                .replace(/?©Îãà??g, '?òÍ≥† ?∂Ï? ÏßÑÏã¨??Í∞Ä?ùÌï¥??)
                                .replace(/Ï£ºÏùò?òÏÑ∏??g, 'Ï°∞Í∏àÎß????†Í≤Ω ?∞Î©¥ Ï¢ãÏùÑ Í≤?Í∞ôÏïÑ??)
                                .replace(/Ï∂îÏ≤ú?©Îãà??g, 'Íº??úÎ≤à ÏßÅÏ†ë ?êÍª¥Î≥¥ÏÖ®?ºÎ©¥ Ï¢ãÍ≤†?¥Ïöî ?ôè')
                                .replace(/Îß§Ïö∞/g, 'Ï∞??∞Îúª?òÍ≥†')
                                .replace(/ÏßÄÍ∏?g, '?§Îäò?∞Îùº ???πÎ≥Ñ??ÏßÄÍ∏?);
                        } else if (personaId === 'cloneme') {
                            transformed = transformed.replace(/??./g, '?ÖÎãà??');
                        }
                        return transformed;
                    };

                    if (variant.sections) {
                        variant.sections = variant.sections.map(s => {
                            const transformed = transformStyle(s.content || s.text || "");
                            return {
                                ...s,
                                content: transformed,
                                text: transformed // Sync for video scripts
                            };
                        });
                    }
                    if (variant.script) {
                        variant.script = variant.script.map(s => {
                            const transformed = transformStyle(s.text || s);
                            return {
                                ...s,
                                text: transformed
                            };
                        });
                    }
                    if (variant.content) {
                        variant.content = transformStyle(variant.content);
                    }
                }

                return {
                    ...prev,
                    variants: updatedVariants
                };
            });
            addNotification("?òÎ•¥?åÎÇò Î¨∏Ï≤¥ Î∞òÏòÅ???ÑÎ£å?òÏóà?µÎãà??", "success");
        }, 250);
    };

    const handleHumanize = () => {
        setIsHumanizing(true);
        setTimeout(() => {
            setFinalData(prev => {
                const updatedVariants = { ...prev.variants };
                const variant = updatedVariants[activeVariant];

                if (variant) {
                    if (variant.sections) {
                        variant.sections = variant.sections.map(s => {
                            const humanized = humanizeText(s.content || s.text || "");
                            return {
                                ...s,
                                content: humanized,
                                text: humanized // Sync for video scripts
                            };
                        });
                    }
                    if (variant.script) {
                        variant.script = variant.script.map(s => {
                            const humanized = humanizeText(s.text || s);
                            return {
                                ...s,
                                text: humanized
                            };
                        });
                    }
                    if (variant.content) {
                        variant.content = humanizeText(variant.content);
                    }
                }

                return {
                    ...prev,
                    variants: updatedVariants,
                    version: (prev.version || 0) + 1,
                    forcedUpdate: true
                };
            });
            setIsHumanizing(false);
            addNotification("?¥Î®∏?òÏù¥Ï¶??îÏßÑ ?ÅÏö© ?ÑÎ£å! ???êÏó∞?§Îü¨??ÎßêÌà¨Î°?Î≥ÄÍ≤ΩÎêò?àÏäµ?àÎã§.", "success");
        }, 400);
    };

    const handleSEOOptimize = () => {
        setIsGenerating(true);
        addNotification("SEO ?ùÌåê???îÏßÑ Í∞Ä??.. ÏΩòÌÖêÏ∏?Íµ¨Ï°∞ ?¨ÏÑ§Í≥?Ï§?..", "info");

        setTimeout(() => {
            setFinalData(prev => {
                const variants = prev.variants || {};
                const variant = variants[activeVariant];
                if (!variant) return prev;

                const updatedVariant = { ...variant };

                if (updatedVariant.isOptimized) {
                    // --- Phase 2: Micro-Tuning ---
                    if (updatedVariant.title) {
                        const currentTitle = updatedVariant.title;
                        if (!currentTitle.includes("?î•") && !currentTitle.includes("?ö®")) {
                            updatedVariant.title = `?î• ${currentTitle.replace(/^\[.*?\]\s*/, "")} (Í∏¥Í∏â Î∂ÑÏÑù)`;
                        } else if (currentTitle.includes("?î•")) {
                            updatedVariant.title = currentTitle.replace(" (Í∏¥Í∏â Î∂ÑÏÑù)", "") + " [?ÑÎèÖ]";
                        }
                    }

                    if (updatedVariant.sections && updatedVariant.sections.length > 0) {
                        const updatedSections = [...updatedVariant.sections];
                        const firstSection = { ...updatedSections[0] };
                        const hooks = [
                            "??Í∏Ä???ΩÍ∏∞ ?ÑÍ≥º ?? ?πÏã†??Í¥Ä?êÏ? ?ÑÏ†Ñ???¨ÎùºÏß?Í≤ÉÏûÖ?àÎã§.",
                            "?¨Ïã§ Í≥µÍ∞ú?†Íπå ÎßêÍπå Í≥†Î??àÏäµ?àÎã§. ?òÏ?Îß?Íµ¨ÎèÖ?êÎãò?§ÏùÑ ?ÑÌï¥ ?âÎãà??",
                            "?ÄÎ∂ÄÎ∂ÑÏùò ?¨Îûå?§Ï? ???¨Ïö¥ Î∞©Î≤ï??Î™∞Îùº???êÌï¥Î•?Î¥ÖÎãà??"
                        ];
                        const randomHook = hooks[Math.floor(Math.random() * hooks.length)];
                        if (firstSection.content && !firstSection.content.includes("??Í∏Ä???ΩÍ∏∞ ??)) {
                            firstSection.content = `"${randomHook}"\n\n` + firstSection.content;
                        }
                        updatedSections[0] = firstSection;
                        updatedVariant.sections = updatedSections;
                    }

                    updatedVariant.score = Math.round(Math.min(100, (updatedVariant.score || 90) + 1));
                    addNotification("?¥Î? ÏµúÏ†Å?îÎêú Íµ¨Ï°∞?ÖÎãà?? ?∏Î†å?úÏóê ÎßûÏ∂∞ '?úÎ™©'Í≥?'?ÑÏûÖÎ∂Ä'Î•??§Îì¨?àÏäµ?àÎã§.", "success");
                } else {
                    // --- Phase 1: Structural Optimization ---
                    const prevTitle = updatedVariant.title || "";
                    updatedVariant.title = `[SEO] ${prevTitle} : ?ÅÏúÑ 1%??ÎπÑÎ? (2025 ÏµúÏã†)`;

                    if (updatedVariant.sections) {
                        updatedVariant.sections = updatedVariant.sections.map(s => {
                            const lsiKeywords = ["?®Ïú® Í∑πÎ???, "?ÑÎ¨∏Í∞Ä Ï∂îÏ≤ú", "?∞Ïù¥??Í≤ÄÏ¶?];
                            const randomLsi = lsiKeywords[Math.floor(Math.random() * lsiKeywords.length)];
                            return {
                                ...s,
                                content: (s.content || "").replace(/(\. )/g, `$1(?µÏã¨ ?§Ïõå?? ${randomLsi}) `)
                            };
                        });
                    }

                    updatedVariant.content = (updatedVariant.sections || []).map(s => s.content || s.text || "").join('\n\n');

                    const improvementFactor = 1.10 + (Math.random() * 0.05);
                    const baseScore = updatedVariant.score || 75;
                    let newScore = baseScore * improvementFactor;
                    newScore = Math.min(99.5, newScore);

                    const newAnalysis = calculateDetailedAnalysis(updatedVariant.title, updatedVariant.sections || [], prev.platform, true);
                    const metricBoost = newScore / (baseScore || 1);

                    updatedVariant.score = Math.round(newScore);
                    updatedVariant.ctr = Math.round(newScore * 0.06 + ((updatedVariant.title || "").length % 5)) + '%';
                    updatedVariant.analysis = {
                        ...newAnalysis,
                        total: Math.round(newScore),
                        spread: Math.min(50, Math.round((newAnalysis?.spread || 0) * metricBoost)),
                        structure: Math.min(30, Math.round((newAnalysis?.structure || 0) * metricBoost)),
                        trend: Math.min(20, Math.round((newAnalysis?.trend || 0) * metricBoost)),
                        pros: 'Í∏∞Ï°¥ ?ÑÎûµ??Í∞ïÏ†ê???†Ï??òÎêò, SEO Ï∑®ÏïΩ?êÏù¥ 10~15% Î≥¥ÏôÑ?òÏóà?µÎãà??',
                        tip: 'Í≤Ä???îÏßÑ ÏπúÌôî?ÑÍ? ?Ä???ÅÏäπ?àÏäµ?àÎã§. ?¥Ï†ú Î∞úÌñâ Ï§ÄÎπÑÍ? ?ÑÎ£å?òÏóà?µÎãà??'
                    };

                    updatedVariant.isOptimized = true;
                    addNotification("SEO ÏµúÏ†Å???ÑÎ£å! ?êÏàòÍ∞Ä ?Ä???•ÏÉÅ?òÏóà?µÎãà??", "success");
                }

                return {
                    ...prev,
                    variants: {
                        ...(prev.variants || {}),
                        [activeVariant]: updatedVariant
                    },
                    version: (prev.version || 0) + 1
                };
            });
            setIsGenerating(false);
        }, 2000);
    };

    const handleFactCheck = () => {
        setIsFactChecking(true);
        setTimeout(() => {
            setFinalData(prev => {
                const variants = prev.variants || {};
                const variant = variants[activeVariant];
                if (!variant) return prev;

                const updatedVariant = { ...variant };
                const targetKey = updatedVariant.script ? 'script' : (updatedVariant.threadPosts ? 'threadPosts' : 'sections');

                if (updatedVariant[targetKey]) {
                    updatedVariant[targetKey] = updatedVariant[targetKey].map(s => {
                        let text = s.content || s.text || "";
                        text = text.replace(/\s+/g, ' ').replace(/\s([.!?])/g, '$1');
                        return { ...s, content: text, text: text };
                    });
                    if (targetKey !== 'sections') updatedVariant.sections = updatedVariant[targetKey];
                }

                return {
                    ...prev,
                    variants: {
                        ...variants,
                        [activeVariant]: updatedVariant
                    }
                };
            });
            setIsFactChecking(false);
            addNotification("?©Ìä∏Ï≤¥ÌÅ¨ Î∞?Î¨∏Ïû• ?ïÎ? Í≤Ä?òÍ? ?ÑÎ£å?òÏóà?µÎãà??", "info");
        }, 500);
    };

    const handleRemix = async (styleId) => {
        addNotification("?§Ì???Î¶¨Î????ùÏÑ± Ï§?..", "info");
        try {
            const remixed = await remixStyle(finalData.content, styleId);
            setFinalData(prev => ({ ...prev, content: remixed }));
            addNotification("Î¶¨Î??§Í? ?±Í≥µ?ÅÏúºÎ°??ÅÏö©?òÏóà?µÎãà??", "success");
        } catch (err) {
            addNotification("Î¶¨Î????§Ìå®", "error");
        }
    };

    const handleAffiliateInject = () => {
        if (affiliateProducts.length === 0) {
            addNotification("Îß§Ïπ≠???ÅÌíà???ÜÏäµ?àÎã§. Î∂ÑÏÑù??Í∏∞Îã§?§Ï£º?∏Ïöî.", "warning");
            return;
        }

        const product = affiliateProducts[0].name;
        const bridgeText = generateNativeBridge(finalData.content, product);

        setFinalData(prev => {
            const updatedVariants = { ...prev.variants };
            const variant = updatedVariants[activeVariant];

            if (variant && variant.sections) {
                // Insert into middle section
                const midIdx = Math.floor(variant.sections.length / 2);
                const updatedSections = [...variant.sections];
                const sectionToUpdate = updatedSections[midIdx];

                const originalText = sectionToUpdate.content || sectionToUpdate.text || "";
                const updatedText = originalText + "\n\n" + bridgeText;

                updatedSections[midIdx] = {
                    ...sectionToUpdate,
                    content: updatedText,
                    text: updatedText
                };

                variant.sections = updatedSections;
                variant.content = updatedSections.map(s => s.content || s.text || "").join('\n\n');

                // Boost score to 100
                variant.score = 100;
                addNotification("?òÏùµ Í∑πÎ?????Hook)??Î≥∏Î¨∏???êÏó∞?§ÎüΩÍ≤??ΩÏûÖ?òÏóà?µÎãà?? ?òÏùµ???êÏàò 100???¨ÏÑ±.", "success");
            }

            return { ...prev, variants: updatedVariants };
        });
    };

    const handleOSMUTransform = (targetPlatform) => {
        setIsGenerating(true);
        addNotification(`${targetPlatform} ?ïÏãù?ºÎ°ú Î≥Ä??Ï§?..`, "info");

        setTimeout(() => {
            const transformed = convertToPlatform({ ...finalData, activeVariant }, targetPlatform);
            setFinalData(transformed);
            setIsGenerating(false);
            addNotification(`${targetPlatform} ÏµúÏ†Å??Î≥Ä???ÑÎ£å!`, "success");
        }, 800);
    };

    const handleTurboMode = async () => {
        setIsProcessingTurbo(true);
        addNotification("?∞Î≥¥ Î™®Îìú(Full-Auto) Í∞Ä?? ?¥Î®º?ºÏù¥Ïß?Î∞?SEO ÏµúÏ†Å?îÎ? ?ºÍ¥Ñ Ï≤òÎ¶¨?©Îãà??", "warning");

        // 1. Humanize
        await new Promise(r => setTimeout(r, 1500));
        const variant = finalData.variants?.[activeVariant];
        const contentStr = (variant?.sections || []).map(s => (s?.content || s?.text || "")).join('\n');
        const humanized = humanizeText(contentStr);

        // 2. Apply SEO Sync (Just logic trigger)
        await new Promise(r => setTimeout(r, 1000));

        setFinalData(prev => {
            const next = { ...prev };
            const variants = next.variants || {};
            const v = variants[activeVariant];
            if (!v) return next;
            const updatedSections = [...(v.sections || [])];
            if (updatedSections[0]) updatedSections[0].content = humanized.split('\n')[0] || updatedSections[0].content;
            v.score = 100;
            return {
                ...next,
                variants: {
                    ...variants,
                    [activeVariant]: {
                        ...v,
                        sections: updatedSections,
                        score: 100
                    }
                }
            };
        });

        setIsProcessingTurbo(false);
        addNotification("?∞Î≥¥ Í≥µÏ†ï ?ÑÎ£å! ?ÅÏúÑ 1% ?ÑÎ¶¨?∞Î°ú Ï¶âÏãú Î∞úÌñâ Í∞Ä?•Ìï©?àÎã§.", "success");
    };

    const handleSave = async () => {
        setIsSaving(true);
        try {
            await addToHistory(displayedData);
            addNotification("Î≥¥Í??®Ïóê ?Ä?•Îêò?àÏäµ?àÎã§. ?òÏùµ ?Ä?úÎ≥¥?úÏóê ?∞Ïù¥?∞Í? Ï¶âÏãú Î∞òÏòÅ?©Îãà??", "success");
        } catch (err) {
            addNotification("?Ä???§Ìå®", "error");
        } finally {
            setIsSaving(false);
        }
    };

    const handleRenderVideo = async () => {
        // Phase 1: Show the Neural Player
        setShowVideoPlayer(true);
    };

    const displayedData = (activePlatformTab === 'MASTER' ? finalData : (platformContents[activePlatformTab] || finalData)) || {};
    const isVideoPlatform = activePlatformTab === 'YOUTUBE' || activePlatformTab === 'INSTAGRAM' || (activePlatformTab === 'MASTER' && ((finalData?.platform || "").includes('Shorts') || (finalData?.platform || "").includes('Reels')));
    const isBlog = activePlatformTab === 'NAVER' || (activePlatformTab === 'MASTER' && (finalData?.platform || "").includes('Blog'));
    const isThreads = activePlatformTab === 'THREADS' || (activePlatformTab === 'MASTER' && (finalData?.platform || "").includes('Threads'));

    // Core Tactical Guard: If we don't have basic data structure, show tactical loader
    if (!finalData || !finalData.topic) {
        return (
            <div className="flex-1 min-h-screen flex flex-col items-center justify-center bg-[#0b0e14] text-white p-20 gap-6">
                <div className="w-16 h-16 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin" />
                <div className="text-center space-y-2">
                    <h3 className="text-xl font-black italic tracking-tighter">NEURAL INITIALIZING...</h3>
                    <p className="text-gray-500 text-sm">?∞Ïù¥??Î¨¥Í≤∞?±ÏùÑ ?ïÏù∏?òÍ≥† ?ÑÎûµ ?Ä?úÎ≥¥?úÎ? Íµ¨ÏÑ± Ï§ëÏûÖ?àÎã§.</p>
                </div>
                <button
                    onClick={() => onBack ? onBack() : window.history.back()}
                    className="mt-4 px-6 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-xs font-bold border border-white/10 transition-all"
                >
                    ?åÏïÑÍ∞ÄÍ∏?
                </button>
            </div>
        );
    }

    const updateContent = (updater) => {
        if (activePlatformTab === 'MASTER') {
            setFinalData(updater);
        } else {
            setPlatformContents(prev => ({
                ...prev,
                [activePlatformTab]: updater(prev[activePlatformTab] || finalData)
            }));
        }
    };

    const handleGeneratePlatformContent = (platformId) => {
        // Prevent generic master tab regeneration
        if (platformId === 'MASTER') return;

        addNotification(`${platformId} ÏµúÏ†Å??ÏΩòÌÖêÏ∏†Î? ?ùÏÑ±?©Îãà??..`, "info");

        // Use finalData & activeVariant as source
        // Ensure we take the specific A/B variant if active
        const sourceData = {
            ...finalData,
            ...(finalData.variants?.[activeVariant] || {}), // Flatten variant data
            variants: finalData.variants // Keep variants just in case
        };

        // Convert using OSMU Engine
        const converted = convertToPlatform(sourceData, platformId);

        // [CRITICAL FIX] Inject converted stats back into the Active Variant
        // ResultView renders from `displayedData.variants[activeVariant]`, so we must update it there.
        if (converted.variants && converted.variants[activeVariant]) {
            converted.variants[activeVariant] = {
                ...converted.variants[activeVariant],
                ...converted, // Inject converted props (threadPosts, script, sections)
                platform: platformId // Ensure platform matches
            };
        } else {
            // Reconstruct variants if missing
            converted.variants = {
                [activeVariant]: {
                    ...sourceData,
                    ...converted,
                    platform: platformId
                }
            };
        }

        setPlatformContents(prev => ({
            ...prev,
            [platformId]: converted
        }));

        setTimeout(() => {
            addNotification(`${platformId} ?ÑÏö© ?¨Îß∑(OSMU) Î≥Ä???ÑÎ£å!`, "success");
        }, 600);
    };
    // Derived content string for effect dependency
    const contentString = (finalData.variants?.[activeVariant]?.sections || finalData.sections || []).map(s => (s?.content || s?.text || "")).join(' ');

    useEffect(() => {
        const timer = setTimeout(() => {
            const matchedNames = matchAffiliateProducts(contentString);

            // Transform into product objects
            const products = matchedNames.map((name, i) => ({
                id: i,
                name,
                price: 45000 + (i * 15000),
                commission: 3,
                image: `https://api.dicebear.com/7.x/identicon/svg?seed=${name}`
            }));

            setAffiliateProducts(products);
        }, 600); // Debounce to prevent layout thrashing (shaking)

        return () => clearTimeout(timer);
    }, [contentString]);

    return (
        <div className="flex justify-start gap-8 max-w-[1800px] mx-auto p-4 md:p-6 pb-32 items-start">
            {/* LEFT COLUMN: Main Content & Header */}
            <div className="flex-1 min-w-0 space-y-8 max-w-[1440px]">
                {/* 2. New Tactical Action Bar (Two Sections) */}
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 relative z-[50] items-start">
                    <div className="lg:col-span-9 space-y-6">
                        {/* 1. MOVED HEADER (Above the First Square) */}
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-6">
                                <motion.button
                                    whileHover={{ scale: 1.1, rotate: -5 }}
                                    whileTap={{ scale: 0.9 }}
                                    onClick={onBack}
                                    className="w-12 h-12 bg-white/5 hover:bg-white/10 text-white rounded-2xl border border-white/5 transition-all flex items-center justify-center flex-shrink-0 shadow-xl"
                                >
                                    <ArrowLeft size={20} />
                                </motion.button>
                                <div className="flex items-center gap-4">
                                    <div className="relative h-14 w-14 flex-shrink-0">
                                        <div className={cn(
                                            "absolute inset-0 blur-xl opacity-40 animate-pulse",
                                            (activePlatformTab === 'YOUTUBE' || displayedData.platform?.includes('Shorts')) && "bg-red-500",
                                            (activePlatformTab === 'INSTAGRAM' || displayedData.platform?.includes('Reels')) && "bg-pink-500",
                                            (activePlatformTab === 'NAVER' || displayedData.platform?.includes('Blog')) && "bg-emerald-500",
                                            (activePlatformTab === 'THREADS' || displayedData.platform?.includes('Threads')) && "bg-white"
                                        )} />
                                        <div className="relative h-full w-full bg-[#13161c] border border-white/10 rounded-2xl flex items-center justify-center p-4 shadow-2xl">
                                            {/* Dynamic Platform Logo */}
                                            {activePlatformTab === 'YOUTUBE' && <BrandLogos.YOUTUBE className="w-full h-full" />}
                                            {activePlatformTab === 'INSTAGRAM' && <BrandLogos.INSTAGRAM className="w-full h-full" />}
                                            {activePlatformTab === 'THREADS' && <BrandLogos.THREADS className="w-full h-full" />}
                                            {activePlatformTab === 'NAVER' && <BrandLogos.NAVER className="w-full h-full" />}
                                            {activePlatformTab === 'MASTER' && (
                                                <>
                                                    {displayedData.platform?.includes('Shorts') && <BrandLogos.YOUTUBE className="w-full h-full" />}
                                                    {displayedData.platform?.includes('Reels') && <BrandLogos.INSTAGRAM className="w-full h-full" />}
                                                    {displayedData.platform?.includes('Threads') && <BrandLogos.THREADS className="w-full h-full" />}
                                                    {(!displayedData.platform || displayedData.platform?.includes('Blog')) && <BrandLogos.NAVER className="w-full h-full" />}
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex flex-col">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="text-[10px] font-black text-indigo-400 uppercase tracking-widest hidden sm:block">AI Content Hub</span>
                                            <div className="w-1 h-1 rounded-full bg-indigo-500" />
                                            <span className="text-[10px] font-medium text-gray-400 uppercase tracking-tight">Active</span>
                                        </div>
                                        <h2 className="text-xl lg:text-3xl font-black text-white leading-none tracking-tighter truncate max-w-[200px] lg:max-w-[400px]">
                                            {displayedData.topic}
                                        </h2>
                                    </div>
                                </div>
                            </div>

                            {/* Restored Action Buttons */}
                            <div className="flex items-center gap-3 lg:mr-8">
                                <Tooltip text="?àÎ°úÍ≥†Ïπ® (Refresh)">
                                    <button
                                        onClick={async () => {
                                            if (window.confirm('ÏΩòÌÖêÏ∏†Î? ?àÎ°úÍ≥†Ïπ® ?òÏãúÍ≤†Ïäµ?àÍπå? (?ÑÏû¨ ?òÏ†ï ?¥Ïö©?Ä ?†Ï??òÏ? ?äÏùÑ ???àÏäµ?àÎã§)')) {
                                                // Refresh Logic
                                                window.location.reload();
                                            }
                                        }}
                                        className="w-12 h-12 rounded-2xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white border border-white/5 transition-all flex items-center justify-center group"
                                    >
                                        <RefreshCcw size={20} className="group-hover:rotate-180 transition-transform duration-500" />
                                    </button>
                                </Tooltip>
                                <Tooltip text="ÎØ∏Î¶¨Î≥¥Í∏∞ (Preview)">
                                    <button
                                        onClick={() => setShowPreview(true)}
                                        className="w-12 h-12 rounded-2xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white border border-white/5 transition-all flex items-center justify-center group"
                                    >
                                        <Eye size={20} className="group-hover:scale-110 transition-transform" />
                                    </button>
                                </Tooltip>
                                <Tooltip text="?Ä??(Save)">
                                    <button
                                        onClick={handleSave}
                                        disabled={isSaving}
                                        className="w-12 h-12 rounded-2xl bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-400 hover:text-indigo-300 border border-indigo-500/30 transition-all flex items-center justify-center group shadow-lg shadow-indigo-500/10"
                                    >
                                        {isSaving ? <Loader size={20} className="animate-spin" /> : <Save size={20} className="group-hover:scale-110 transition-transform" />}
                                    </button>
                                </Tooltip>
                            </div>
                        </div>

                        <div className="flex items-stretch gap-6">
                            {/* LEFT SECTION: Platform Command */}
                            <div className="flex-1 bg-[#0b0e14]/90 backdrop-blur-2xl border border-white/10 rounded-[28px] p-1.5 flex items-center gap-1 shadow-2xl relative overflow-hidden group/platform">
                                <div className="absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-white/10 to-transparent" />

                                <div className="flex items-center gap-1 w-full py-2 px-2">
                                    {[
                                        {
                                            id: 'MASTER', label: '?ÑÏ≤¥', Logo: BrandLogos.MASTER,
                                            activeClass: "bg-gradient-to-br from-amber-500/20 via-amber-900/10 to-black/20 border-amber-500/30 shadow-[0_0_20px_rgba(245,158,11,0.1)]",
                                            glowColor: "from-amber-500/20"
                                        },
                                        {
                                            id: 'YOUTUBE', label: '?ºÏ∏†', Logo: BrandLogos.YOUTUBE,
                                            activeClass: "bg-gradient-to-br from-red-600/20 via-red-900/10 to-black/20 border-red-500/30 shadow-[0_0_20px_rgba(220,38,38,0.1)]",
                                            glowColor: "from-red-600/20"
                                        },
                                        {
                                            id: 'INSTAGRAM', label: 'Î¶¥Ïä§', Logo: BrandLogos.INSTAGRAM,
                                            activeClass: "bg-gradient-to-br from-pink-500/20 via-purple-900/10 to-black/20 border-pink-500/30 shadow-[0_0_20px_rgba(236,72,153,0.1)]",
                                            glowColor: "from-pink-500/20"
                                        },
                                        {
                                            id: 'NAVER', label: 'Î∏îÎ°úÍ∑?, Logo: BrandLogos.NAVER,
                                            activeClass: "bg-gradient-to-br from-emerald-500/20 via-emerald-900/10 to-black/20 border-emerald-500/30 shadow-[0_0_20px_rgba(16,185,129,0.1)]",
                                            glowColor: "from-emerald-500/20"
                                        },
                                        {
                                            id: 'THREADS', label: '?§Î†à??, Logo: BrandLogos.THREADS,
                                            activeClass: "bg-gradient-to-br from-white/10 via-gray-800/20 to-black/20 border-white/20 shadow-[0_0_20px_rgba(255,255,255,0.05)]",
                                            glowColor: "from-white/10"
                                        }
                                    ].map((tab) => (
                                        <button
                                            key={tab.id}
                                            onClick={() => {
                                                setActivePlatformTab(tab.id);
                                                setActivePlatform(tab.id);
                                                if (tab.id !== 'MASTER' && !platformContents[tab.id]) {
                                                    handleGeneratePlatformContent(tab.id);
                                                }
                                            }}
                                            className={cn(
                                                "flex-1 h-24 relative group flex flex-col items-center justify-center rounded-2xl border transition-all duration-300 overflow-hidden gap-1",
                                                activePlatformTab === tab.id
                                                    ? tab.activeClass
                                                    : "bg-white/[0.02] border-white/[0.05] hover:bg-white/[0.05] hover:border-white/10"
                                            )}
                                        >
                                            {activePlatformTab === tab.id && (
                                                <div className={cn("absolute inset-0 bg-gradient-to-br opacity-10 blur-xl transition-all duration-500", tab.glowColor)} />
                                            )}
                                            <tab.Logo className={cn(
                                                "w-16 h-16 transition-all duration-300 z-10",
                                                activePlatformTab === tab.id ? "scale-110 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]" : "group-hover:scale-105"
                                            )} />
                                            <span className={cn(
                                                "text-[11px] font-black uppercase tracking-tighter transition-all z-10",
                                                activePlatformTab === tab.id ? "text-white" : "text-gray-500 group-hover:text-gray-300"
                                            )}>
                                                {tab.label}
                                            </span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* RIGHT SECTION: Strategic Icons Grid - Resized to match Platform Command */}
                            <div className="w-[380px] lg:mr-8 bg-[#0b0e14]/90 backdrop-blur-2xl border border-white/10 rounded-[28px] p-1.5 shadow-2xl relative group/actions flex items-center flex-shrink-0">
                                <div className="absolute top-0 right-0 w-full h-px bg-gradient-to-l from-transparent via-white/10 to-transparent" />

                                <div className="grid grid-cols-4 gap-1 w-full">
                                    <Tooltip text="?∏ÌÖîÎ¶¨Ï†Ñ???µÍ≥Ñ Î∂ÑÏÑù: ?®Ïàú ?òÏπòÎ•??òÏñ¥ ?¨Ïö©??Ï≤¥Î•ò ?úÍ∞Ñ, ?¥Î¶≠ ?ÑÏù¥??CTR), Í∑∏Î¶¨Í≥??ÑÌôò ?¥ÌÉà ?®ÌÑ¥???§Ï∞®??Î≤°ÌÑ∞Î°?Î∂ÑÏÑù?òÏó¨ ÏΩòÌÖêÏ∏†Ïùò Í∞ùÍ????±Í≥º?Ä Í∞úÏÑ† ÏßÄ?úÎ? ?ïÎ? ÏßÑÎã®?©Îãà??" position="top">
                                        <button onClick={() => setShowDetailedStats(true)} className="w-full h-24 flex flex-col items-center justify-center rounded-2xl bg-indigo-500/5 hover:bg-indigo-500/20 text-indigo-400 border border-indigo-500/10 hover:border-indigo-500/30 transition-all group/icon gap-1">
                                            <BarChart3 size={48} className="group-hover/icon:scale-110 transition-transform z-10" />
                                            <span className="text-[11px] font-black uppercase tracking-tighter text-indigo-400/80 group-hover:text-indigo-400 z-10">?µÍ≥Ñ Î∂ÑÏÑù</span>
                                        </button>
                                    </Tooltip>

                                    <Tooltip text="?¥Îü¥ Ïª¥Ìéò?∞ÌÑ∞ Î¶¨ÏΩò: ?úÏû• ?ÅÏúÑ 1% Í≤ΩÏüÅ ÏΩòÌÖêÏ∏†Ïùò ?òÎ?Î°†Ï†Å(Semantic) Ï∑®ÏïΩ?êÍ≥º ?§Ïõå???êÏú† Í≥µÎ∞±??AIÍ∞Ä ?¨Ï∏µ ?∏Î¶¨ Íµ¨Ï°∞Î°?Î∂ÑÏÑù?òÏó¨, ?ÖÏ†ê???úÏû• ?∞ÏúÑÎ•??ïÎ≥¥???ÑÏà†???åÍ≥†?§Í∏∞ ÏßÄ?êÏùÑ Î∞úÍ≤¨?©Îãà??" position="top">
                                        <button
                                            onClick={() => {
                                                setIsAnalyzingGap(true);
                                                addNotification("?ÅÏßÑ Î∂ÑÏÑù Î∂Ä?Ä Í∞Ä??..", "info");
                                                setTimeout(() => {
                                                    setIsAnalyzingGap(false);
                                                    setShowGapAnalysis(true);
                                                    addNotification("ÎπàÌãà Î∂ÑÏÑù ?ÑÎ£å!", "success");
                                                }, 1500);
                                            }}
                                            className="w-full h-24 flex flex-col items-center justify-center rounded-2xl bg-rose-500/5 hover:bg-rose-500/20 text-rose-400 border border-rose-500/10 hover:border-rose-500/30 transition-all group/icon gap-1"
                                        >
                                            {isAnalyzingGap ? <RefreshCcw className="animate-spin" size={28} /> : <Eye size={48} className="group-hover/icon:scale-110 transition-transform z-10" />}
                                            <span className="text-[11px] font-black uppercase tracking-tighter text-rose-400/80 group-hover:text-rose-400 z-10">Í≤ΩÏüÅ Ï∂îÏ†Å</span>
                                        </button>
                                    </Tooltip>

                                    <Tooltip text="?ÑÎûµ ?úÎ??àÏù¥???åÍ≤å?? Î∞úÌñâ ??ÏΩòÌÖêÏ∏†Î? ?ÖÏûê?ÅÏù∏ Í∞Ä???∏Îûò???îÏßÑ???¨ÏûÖ?òÏó¨, ?§ÏãúÍ∞?Í≤ΩÏüÅ Í≤åÏãúÎ¨ºÎì§Í≥ºÏùò ?åÍ≥†Î¶¨Ï¶ò ÍµêÏ†Ñ???úÎ??àÏù¥?òÌïòÍ≥?ÏµúÏ¢Ö ?àÏÉÅ ?ÑÎã¨ ?±Í≥º?Ä ?ùÏ†Ñ ?πÎ•†???ïÎüâ?îÌïò???úÍ≥µ?©Îãà??" position="top">
                                        <button onClick={runWarGame} className="w-full h-24 flex flex-col items-center justify-center rounded-2xl bg-amber-500/5 hover:bg-amber-500/20 text-amber-400 border border-amber-500/10 hover:border-amber-500/30 transition-all group/icon gap-1">
                                            <Sword size={48} className="group-hover/icon:rotate-12 transition-transform z-10" />
                                            <span className="text-[11px] font-black uppercase tracking-tighter text-amber-400/80 group-hover:text-amber-400 z-10">?§Ï†Ñ ÍµêÏ†Ñ</span>
                                        </button>
                                    </Tooltip>

                                    <Tooltip text="ÏßÄ?•Ìòï ?êÏú® ?§ÌÜ†?åÏùº?? ?¥Î®∏?òÏù¥Ïß??îÏßÑ???µÌïú Î¨∏Ï≤¥ ÏµúÏ†Å?? Îß•ÎùΩ Í∏∞Î∞ò ?òÏù¥??Î°úÏª¨ ?¥Ïãú?úÍ∑∏ ?ùÏÑ±, Í∑∏Î¶¨Í≥??ÄÍ≤??§Îîî?∏Ïä§ Î∞òÏùëÎ•†Ïù¥ Í∑πÎ??îÎêò??Í≥®Îì† ?Ä???êÎèô Î∞úÌñâ??AIÍ∞Ä ?ÑÏ†Ñ ?êÏú® ?òÌñâ?©Îãà??" position="top">
                                        <button
                                            onClick={() => {
                                                setIsAutoPilotActive(!isAutoPilotActive);
                                                addNotification(isAutoPilotActive ? "?§ÌÜ†?åÏùº???¥Ï†ú" : "?§ÌÜ†?åÏùº??Í∞Ä??, "info");
                                            }}
                                            className={cn(
                                                "w-full h-24 flex flex-col items-center justify-center rounded-2xl border transition-all group/icon gap-1",
                                                isAutoPilotActive
                                                    ? "bg-emerald-600 text-white border-emerald-400 shadow-[0_0_15px_rgba(16,185,129,0.3)]"
                                                    : "bg-emerald-500/5 hover:bg-emerald-500/20 text-emerald-400 border-emerald-500/10 hover:border-emerald-500/30"
                                            )}
                                        >
                                            <Rocket size={48} className={cn("z-10", isAutoPilotActive ? "animate-bounce" : "group-hover/icon:-translate-y-0.5 transition-transform")} />
                                            <span className={cn("text-[11px] font-black uppercase tracking-tighter z-10", isAutoPilotActive ? "text-white" : "text-emerald-400/80 group-hover:text-emerald-400")}>?êÏú® Ï£ºÌñâ</span>
                                        </button>
                                    </Tooltip>
                                </div>
                            </div>
                        </div>

                        {/* AI A/B Test Report (Now below Platform Command) */}

                        {/* RE-LOCATED: Integrated Top Actions (Image Cards) */}


                        {/* Primary Editor Workspace (Promoted to Tactical Area) */}
                        <div className="bg-surface/30 backdrop-blur-2xl border border-white/5 rounded-[40px] overflow-hidden flex flex-col shadow-2xl">
                            {/* Workspace Toolbar */}
                            <div className="flex items-center justify-between px-8 py-5 border-b border-white/5 bg-white/[0.02]">
                                <div className="flex items-center gap-4">
                                    <div className="p-2 bg-indigo-500/10 rounded-xl text-indigo-400">
                                        <Layout size={18} />
                                    </div>
                                    <div className="flex flex-col">
                                        <h3 className="text-lg font-black text-white">{isBlog ? 'Î¨∏ÏÑú ?êÎîî??(Document Editor)' : '?úÎÇòÎ¶¨Ïò§ ?§ÌÅ¨Î¶ΩÌä∏ (Storyline)'}</h3>
                                        <span className="text-[10px] text-gray-500 font-bold uppercase tracking-widest leading-none">?ÑÏû¨ Ï¥àÏïà: {activeVariant} Variant</span>
                                    </div>
                                </div>

                                <div className="flex items-center gap-2">
                                    <Tooltip text="AI Í∏∞Í≥Ñ??ÎßêÌà¨ ?úÍ±∞ Î∞?Íµ¨Ïñ¥Ï≤?Î≥Ä??>
                                        <button
                                            onClick={handleHumanize}
                                            disabled={isHumanizing}
                                            className="h-10 px-5 bg-purple-500/10 hover:bg-purple-500/20 text-purple-400 text-xs font-bold rounded-xl border border-purple-500/20 transition-all flex items-center gap-2 active:scale-95 disabled:opacity-50"
                                        >
                                            <Sparkles size={14} className={isHumanizing ? "animate-pulse" : ""} />
                                            {isHumanizing ? "Humanizing..." : "?¥Î®∏?òÏù¥Ï¶?}
                                        </button>
                                    </Tooltip>
                                    <Tooltip text="?§ÏãúÍ∞??∞Ïù¥???©Ìä∏Ï≤¥ÌÅ¨ Î∞??∏Ïö©Íµ?Î≥¥Í∞ï">
                                        <button
                                            onClick={handleFactCheck}
                                            disabled={isFactChecking}
                                            className="h-10 px-5 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 text-xs font-bold rounded-xl border border-blue-500/20 transition-all flex items-center gap-2 active:scale-95 disabled:opacity-50"
                                        >
                                            <CheckCircle2 size={14} className={isFactChecking ? "animate-pulse" : ""} />
                                            {isFactChecking ? "Verifying..." : "?©Ìä∏Ï≤¥ÌÅ¨"}
                                        </button>
                                    </Tooltip>
                                    <Tooltip text="?åÎû´?ºÎ≥Ñ ?§Ï†ú Î∞úÌñâ ?àÏãú ÎØ∏Î¶¨Î≥¥Í∏∞">
                                        <button
                                            onClick={() => setShowPreview(true)}
                                            className="h-10 px-5 bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 text-xs font-bold rounded-xl border border-amber-500/20 transition-all flex items-center gap-2 active:scale-95"
                                        >
                                            <Eye size={14} />
                                            ÎØ∏Î¶¨Î≥¥Í∏∞
                                        </button>
                                    </Tooltip>
                                </div>
                            </div>

                            {/* Professional Editor Content Area - Integrated Live Editor */}
                            <div className="p-8 lg:p-12 min-h-[600px] relative">
                                {/* Floating Status Corner */}
                                <div className="absolute top-12 right-12 z-10 flex flex-col items-end gap-1.5 pointer-events-none">
                                    <div className="px-3 py-1 bg-green-500/10 border border-green-500/20 rounded-full">
                                        <span className="text-[9px] font-black text-green-500 text-center tracking-tighter">SUCCESSIVE_VIBE_READY</span>
                                    </div>
                                    <span className="text-[9px] text-gray-600 font-bold uppercase tracking-widest">{getTotalCharCount().toLocaleString()} CHARS</span>
                                </div>

                                <div className="relative z-10 mt-8">
                                    {isBlog && (
                                        <motion.div key={activeVariant} initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="max-w-[800px] mx-auto text-center">
                                            <div className="border-b border-white/5 pb-10 mb-10">
                                                <input
                                                    type="text"
                                                    value={displayedData.variants?.[activeVariant]?.title || displayedData.title || ""}
                                                    onChange={(e) => {
                                                        const val = e.target.value;
                                                        updateContent(prev => {
                                                            const variants = prev.variants || {};
                                                            const variant = variants[activeVariant] || {};
                                                            return {
                                                                ...prev,
                                                                variants: {
                                                                    ...variants,
                                                                    [activeVariant]: { ...variant, title: val }
                                                                }
                                                            };
                                                        });
                                                    }}
                                                    className="w-full bg-transparent text-lg lg:text-2xl font-black text-white text-center border-none focus:outline-none focus:ring-2 ring-indigo-500/20 rounded-xl p-4 leading-tight"
                                                    placeholder="?úÎ™©???ÖÎ†•?òÏÑ∏??.."
                                                />
                                            </div>

                                            <div className="space-y-12">
                                                {(displayedData.variants?.[activeVariant]?.sections || displayedData.sections || [{ title: 'Î≥∏Î°†', content: displayedData.content || "" }]).map((section, idx) => (
                                                    <div key={`${activeVariant}-section-${idx}`} className="group/section space-y-4">
                                                        {section.title && (
                                                            <div className="flex flex-col items-center">
                                                                <div className="w-12 h-1 bg-green-500/30 rounded-full mb-3" />
                                                                <input
                                                                    type="text"
                                                                    value={section.title}
                                                                    onChange={(e) => {
                                                                        const val = e.target.value;
                                                                        updateContent(prev => {
                                                                            const variants = prev.variants || {};
                                                                            const variant = variants[activeVariant] || {};
                                                                            const sections = [...(variant.sections || prev.sections || [])];
                                                                            if (sections[idx]) {
                                                                                sections[idx] = { ...sections[idx], title: val };
                                                                            }
                                                                            return {
                                                                                ...prev,
                                                                                variants: { ...variants, [activeVariant]: { ...variant, sections } }
                                                                            };
                                                                        });
                                                                    }}
                                                                    className="bg-transparent text-base font-black text-indigo-400 text-center border-none focus:outline-none focus:ring-1 ring-white/10 rounded-lg px-4 py-1"
                                                                />
                                                            </div>
                                                        )}
                                                        <textarea
                                                            value={section.content || section.text || ""}
                                                            onChange={(e) => {
                                                                const val = e.target.value;
                                                                updateContent(prev => {
                                                                    const variants = prev.variants || {};
                                                                    const variant = variants[activeVariant] || {};
                                                                    const sections = [...(variant.sections || prev.sections || [{ title: 'Î≥∏Î°†', content: '' }])];
                                                                    if (sections[idx]) {
                                                                        sections[idx] = { ...sections[idx], content: val, text: val };
                                                                    }
                                                                    return {
                                                                        ...prev,
                                                                        variants: {
                                                                            ...variants,
                                                                            [activeVariant]: {
                                                                                ...variant,
                                                                                sections,
                                                                                content: sections.map(s => s.content || s.text || "").join('\n\n')
                                                                            }
                                                                        }
                                                                    };
                                                                });
                                                            }}
                                                            rows={Math.max(4, (section.content || section.text || "").split('\n').length)}
                                                            className="w-full bg-transparent text-base lg:text-lg text-gray-300 leading-[1.8] font-medium text-center border-none focus:outline-none focus:ring-1 ring-white/5 rounded-2xl p-6 resize-none transition-all hover:bg-white/[0.02]"
                                                            placeholder="?¥Ïö©???ÖÎ†•?òÏÑ∏??.."
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        </motion.div>
                                    )}

                                    {isVideoPlatform && (
                                        <div className="space-y-6">
                                            {(displayedData.variants?.[activeVariant]?.sections || displayedData.variants?.[activeVariant]?.script || displayedData.script || []).map((line, idx) => (
                                                <div key={`${activeVariant}-script-${idx}`} className="grid grid-cols-12 gap-6 p-6 bg-white/5 border border-white/5 rounded-2xl hover:bg-white/10 transition-all group/line">
                                                    <div className="col-span-2 flex flex-col items-center">
                                                        <input
                                                            type="text"
                                                            value={line.time}
                                                            onChange={(e) => {
                                                                const val = e.target.value;
                                                                updateContent(prev => {
                                                                    const variants = prev.variants || {};
                                                                    const variant = variants[activeVariant] || {};
                                                                    const script = [...(variant.sections || variant.script || prev.script || [])];
                                                                    if (script[idx]) {
                                                                        script[idx] = { ...script[idx], time: val };
                                                                    }
                                                                    return { ...prev, variants: { ...variants, [activeVariant]: { ...variant, sections: script, script } } };
                                                                });
                                                            }}
                                                            className="w-full bg-transparent text-xs font-black text-indigo-400 font-mono text-center border-none focus:outline-none"
                                                        />
                                                    </div>
                                                    <div className="col-span-10 space-y-3">
                                                        <textarea
                                                            value={line.text || line.content || ""}
                                                            onChange={(e) => {
                                                                const val = e.target.value;
                                                                updateContent(prev => {
                                                                    const variants = prev.variants || {};
                                                                    const variant = variants[activeVariant] || {};
                                                                    const script = [...(variant.sections || variant.script || prev.script || [])];
                                                                    if (script[idx]) {
                                                                        script[idx] = { ...script[idx], text: val, content: val };
                                                                    }
                                                                    return {
                                                                        ...prev,
                                                                        variants: {
                                                                            ...variants,
                                                                            [activeVariant]: {
                                                                                ...variant,
                                                                                sections: script,
                                                                                script,
                                                                                content: script.map(s => s.text || s.content || "").join('\n')
                                                                            }
                                                                        }
                                                                    };
                                                                });
                                                            }}
                                                            rows={2}
                                                            className="w-full bg-transparent text-base lg:text-lg text-white font-bold leading-relaxed border-none focus:outline-none resize-none p-0"
                                                        />
                                                        <input
                                                            type="text"
                                                            value={line.visual || ""}
                                                            onChange={(e) => {
                                                                const val = e.target.value;
                                                                updateContent(prev => {
                                                                    const variants = prev.variants || {};
                                                                    const variant = variants[activeVariant] || {};
                                                                    const script = [...(variant.sections || variant.script || prev.script || [])];
                                                                    if (script[idx]) {
                                                                        script[idx] = { ...script[idx], visual: val };
                                                                    }
                                                                    return { ...prev, variants: { ...variants, [activeVariant]: { ...variant, sections: script, script } } };
                                                                });
                                                            }}
                                                            className="w-full text-[10px] text-gray-500 italic bg-black/40 p-2 rounded-lg border border-white/5 focus:outline-none focus:border-indigo-500/50"
                                                            placeholder="Visual direction..."
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {isThreads && (
                                        <div className="max-w-xl mx-auto space-y-6">
                                            {(() => {
                                                const variant = displayedData.variants?.[activeVariant];
                                                const renderPosts = variant?.threadPosts || variant?.sections || displayedData.threadPosts || displayedData.sections || displayedData.script || [];

                                                return renderPosts.map((post, idx) => (
                                                    <div key={idx} className="bg-black/40 border border-white/10 rounded-3xl p-6 flex gap-4 overflow-hidden relative">
                                                        <div className="w-10 h-10 rounded-full bg-indigo-500 shrink-0 flex items-center justify-center font-bold text-xs text-white z-10">#{idx + 1}</div>
                                                        <div className="flex-1 min-w-0 relative">
                                                            <textarea
                                                                value={post.text || post.content || ""}
                                                                onChange={(e) => {
                                                                    const val = e.target.value;
                                                                    updateContent(prev => {
                                                                        const next = { ...prev };
                                                                        if (next.variants && next.variants[activeVariant]) {
                                                                            const v = next.variants[activeVariant];
                                                                            const newPosts = [...(v.threadPosts || v.sections || [])];
                                                                            if (newPosts[idx]) newPosts[idx] = { ...newPosts[idx], text: val, content: val };
                                                                            return {
                                                                                ...next,
                                                                                variants: {
                                                                                    ...next.variants,
                                                                                    [activeVariant]: {
                                                                                        ...v,
                                                                                        threadPosts: newPosts,
                                                                                        sections: newPosts,
                                                                                        content: newPosts.map(p => p.text || p.content || "").join('\n\n')
                                                                                    }
                                                                                }
                                                                            };
                                                                        }
                                                                        else {
                                                                            const currentSource = next.threadPosts || next.sections || next.script || [];
                                                                            const newPosts = [...currentSource];
                                                                            if (newPosts[idx]) newPosts[idx] = { ...newPosts[idx], text: val, content: val };
                                                                            return {
                                                                                ...next,
                                                                                threadPosts: newPosts,
                                                                                sections: newPosts,
                                                                                script: next.script ? newPosts : next.script,
                                                                                content: newPosts.map(p => p.text || p.content || "").join('\n\n')
                                                                            };
                                                                        }
                                                                    });
                                                                }}
                                                                rows={Math.max(3, Math.min(10, (post.text || "").split('\n').length))}
                                                                className="w-full bg-transparent text-gray-200 text-sm leading-relaxed border-none focus:outline-none resize-none min-w-0"
                                                                placeholder="?¥Ïö©???ÖÎ†•?òÏÑ∏??.."
                                                            />
                                                        </div>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Native Multi-modal Render Interface */}
                        <div className="bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10 border border-white/10 rounded-[32px] mb-8 relative overflow-hidden group/video-loop">
                            <div className="absolute top-0 right-0 p-3 opacity-10 rotate-12 group-hover/video-loop:rotate-0 transition-transform">
                                <Film size={60} className="text-white" />
                            </div>

                            <div className="p-8 pb-28 relative z-10">
                                <div className="space-y-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-2xl bg-indigo-500 flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                            <Bot size={20} />
                                        </div>
                                        <h3 className="text-xl font-black text-white tracking-tight italic">?§Ïù¥?∞Î∏å Î©Ä?∞Î™®??Î£®ÌîÑ (Multi-Modal Loop)</h3>
                                    </div>
                                    <p className="text-sm text-gray-400 font-medium leading-relaxed max-w-2xl">
                                        ?ÑÏû¨ ?∏Ïßë Ï§ëÏù∏ {isVideoPlatform ? '?§ÌÅ¨Î¶ΩÌä∏Î•?Í∏∞Î∞ò?ºÎ°ú ?§Ï†ú Í≥†ÌôîÏß??ÅÏÉÅÍ≥?AI ?åÏÑ±(TTS)' : '?êÍ≥†Î•?Í∏∞Î∞ò?ºÎ°ú ???òÏù¥?ºÏù¥???ÅÏÉÅ'}??Ï¶âÏãú ?ùÏÑ±?©Îãà??
                                        <span className="text-indigo-400 font-bold ml-1">?ÑÏÑ±??.mp4 ?åÏùº??Ïª®Ìéå?òÍ≥† Î∞îÎ°ú ?ÖÎ°ú?úÌïò?∏Ïöî.</span>
                                    </p>
                                </div>
                            </div>

                            {/* Bottom Action Bar */}
                            <div className="absolute bottom-0 left-0 right-0 p-6 bg-black/20 backdrop-blur-xl border-t border-white/5 flex gap-3 items-center justify-end z-20">
                                {!renderedVideo ? (
                                    <>
                                        <button
                                            onClick={() => setShowVisualAudition(true)}
                                            className="px-6 py-4 bg-white/5 hover:bg-white/10 text-white font-black text-xs rounded-2xl border border-white/10 active:scale-95 transition-all flex items-center gap-2 group/audition"
                                        >
                                            <Eye size={16} className="text-gray-400 group-hover/audition:text-amber-500 transition-colors" />
                                            ?∏ÎÑ§???§Îîî??
                                        </button>
                                        <button
                                            onClick={handleRenderVideo}
                                            disabled={isRenderingVideo}
                                            className="flex-1 px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-black text-xs rounded-2xl shadow-xl shadow-indigo-600/20 active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-50 group/render"
                                        >
                                            {isRenderingVideo ? <Loader className="animate-spin" size={16} /> : <Zap size={16} className="group-hover/render:animate-pulse" />}
                                            {isRenderingVideo ? "?åÎçîÎß?Ï§?.." : "?ÑÏ†ú???ÅÏÉÅ ?ùÏÑ± ?úÏûë"}
                                        </button>
                                    </>
                                ) : (
                                    <motion.div
                                        initial={{ scale: 0.9, opacity: 0 }}
                                        animate={{ scale: 1, opacity: 1 }}
                                        className="flex items-center gap-4 w-full justify-end"
                                    >
                                        <button
                                            onClick={() => setRenderedVideo(null)}
                                            className="text-[11px] font-black text-gray-500 uppercase hover:text-white transition-colors"
                                        >
                                            ?¨ÏÉù??(Re-Render)
                                        </button>
                                        <div className="px-6 py-3 bg-emerald-500 text-black font-black text-xs rounded-xl flex items-center gap-2 shadow-lg shadow-emerald-500/20">
                                            <CheckCircle2 size={14} /> Î∞úÌñâ Ï§ÄÎπ??ÑÎ£å
                                        </div>
                                    </motion.div>
                                )}
                            </div>
                        </div>

                        {/* Video Player Preview and Metrics Area */}
                        <AnimatePresence>
                            {renderedVideo && (
                                <motion.div
                                    initial={{ height: 0, opacity: 0, marginTop: 0 }}
                                    animate={{ height: 'auto', opacity: 1, marginTop: 32 }}
                                    exit={{ height: 0, opacity: 0, marginTop: 0 }}
                                    className="overflow-hidden mb-8"
                                >
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center bg-black/60 rounded-[28px] p-6 border border-white/10">
                                        <div className="aspect-[9/16] max-h-[400px] bg-black rounded-2xl overflow-hidden relative shadow-2xl mx-auto lg:mx-0">
                                            <video
                                                controls
                                                autoPlay
                                                muted
                                                className="w-full h-full object-cover"
                                                poster={renderedVideo.thumbnail}
                                            >
                                                <source src={renderedVideo.videoUrl} type="video/mp4" />
                                            </video>
                                        </div>
                                        <div className="space-y-6">
                                            <div className="space-y-4">
                                                <div className="flex items-center justify-between border-b border-white/5 pb-2">
                                                    <span className="text-xs text-gray-500 font-bold uppercase tracking-widest">Render Metrics</span>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <div className="text-[10px] text-gray-600 font-bold uppercase mb-1">Duration</div>
                                                        <div className="text-sm font-black text-white">{renderedVideo.duration}</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-[10px] text-gray-600 font-bold uppercase mb-1">File Size</div>
                                                        <div className="text-sm font-black text-white">{renderedVideo.fileSize}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                <button className="w-full py-4 bg-white/10 hover:bg-white/20 text-white font-black text-sm rounded-2xl transition-all flex items-center justify-center gap-3">
                                                    ?åÏùº ?§Ïö¥Î°úÎìú (.MP4)
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>


                    </div>

                    {/* Right Tactical Column (Swapped Order) */}
                    <div className="lg:col-span-3 space-y-8">
                        {/* Viral SEO Super Analysis (Deeper Insight) - RELOCATED TO TOP */}
                        {/* Viral SEO Super Analysis (Deeper Insight) - RELOCATED TO TOP */}
                        <ContentCard className="bg-[#0f111a] border border-white/5 relative overflow-hidden">
                            {(() => {
                                const currentVariant = displayedData.variants?.[activeVariant] || { score: 0, ctr: '0%' };
                                return (
                                    <>
                                        <div className="flex flex-col gap-4 mb-8">
                                            <div className="flex items-start justify-between">
                                                <div className="flex items-center gap-3">
                                                    <Signal size={20} className="text-indigo-400" />
                                                    <h3 className="text-[16px] font-black text-white text-center">SEO ÏµúÏ†Å??Î∂ÑÏÑù</h3>
                                                </div>
                                                <Tooltip text={
                                                    <div className="space-y-2">
                                                        <p className={`font-bold ${currentVariant.score >= 90 ? 'text-emerald-400' : 'text-amber-400'}`}>
                                                            {currentVariant.score >= 90 ? 'AI Î∂ÑÏÑù: ?ÑÎ≤Ω???ïÏÇ∞ Íµ¨Ï°∞Î•?Í∞ñÏ∂îÍ≥??àÏäµ?àÎã§.' : `AI ?úÏïà: ${currentVariant.analysis?.tip || 'ÏΩòÌÖêÏ∏?Î≥¥Í∞ï???ÑÏöî?©Îãà??'}`}
                                                        </p>
                                                        <p className="text-gray-400">
                                                            {currentVariant.analysis?.pros || (activeVariant === 'B' ? '?êÍ∑π?ÅÏù∏ ?ÖÏù¥ ?¨Ìï®?òÏñ¥ ?àÏñ¥ Ï¥àÍ∏∞ ?ÑÌåå?•Ïù¥ Îß§Ïö∞ ?íÏùÑ Í≤ÉÏúºÎ°??àÏÉÅ?©Îãà??' : 'Í≤Ä??Í∏∞Î∞ò ?†ÏûÖ??ÏµúÏ†Å?îÎêú ?ïÎ≥¥??Íµ¨Ï°∞?ÖÎãà??')}
                                                        </p>
                                                    </div>
                                                }>
                                                    <div className={`px-4 py-1.5 rounded-full border transition-all flex items-center gap-2 cursor-help whitespace-nowrap ${currentVariant.score >= 90 ? 'bg-emerald-500/10 border-emerald-500/20' : 'bg-amber-500/10 border-amber-500/20'}`}>
                                                        <span className={`text-[14px] font-black whitespace-nowrap ${currentVariant.score >= 90 ? 'text-emerald-500' : 'text-amber-500'}`}>
                                                            {currentVariant.score >= 90 ? 'ÏµúÏ†Å???ÑÎ£å' : 'Í∞úÏÑ† ?ÑÏöî'}
                                                        </span>
                                                        <Info size={14} className={currentVariant.score >= 90 ? 'text-emerald-500' : 'text-amber-500'} />
                                                    </div>
                                                </Tooltip>
                                            </div>
                                        </div>

                                        {/* Score Gauge */}
                                        <div className="flex justify-center mb-10">
                                            <div className="relative w-44 h-44">
                                                <svg className="w-full h-full transform -rotate-90">
                                                    <circle cx="88" cy="88" r="76" stroke="rgba(255,255,255,0.05)" strokeWidth="16" fill="transparent" />
                                                    <motion.circle
                                                        key={activeVariant}
                                                        cx="88" cy="88" r="76"
                                                        stroke={currentVariant.score >= 90 ? "#10b981" : "#facc15"}
                                                        strokeWidth="16"
                                                        fill="transparent"
                                                        strokeDasharray={477.5}
                                                        initial={{ strokeDashoffset: 477.5 }}
                                                        animate={{ strokeDashoffset: 477.5 - (477.5 * currentVariant.score / 100) }}
                                                        transition={{ duration: 1, ease: "easeOut" }}
                                                        strokeLinecap="round"
                                                    />
                                                </svg>
                                                <div className="absolute inset-0 flex flex-col items-center justify-center">
                                                    <motion.span
                                                        key={activeVariant}
                                                        initial={{ scale: 0.5, opacity: 0 }}
                                                        animate={{ scale: 1, opacity: 1 }}
                                                        className="text-5xl font-black text-white"
                                                    >
                                                        {Math.round(currentVariant.score || 0)}
                                                    </motion.span>
                                                    <span className="text-xs text-gray-500 font-bold mt-1 uppercase tracking-widest">Î∂ÑÏÑù ?êÏàò</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Detailed Report Panel */}
                                        <div className="bg-white/5 rounded-3xl p-6 space-y-6">
                                            <h4 className="text-lg font-bold text-gray-400 text-center mb-2">?ÅÏÑ∏ ?âÍ? Î¶¨Ìè¨??/h4>
                                            <div className="space-y-4">
                                                <div className="space-y-2">
                                                    <div className="flex justify-between items-center text-sm font-bold">
                                                        <span className="text-gray-300">?§ñ AI ?ïÏÇ∞ ?àÏ∏°</span>
                                                        <span className="text-white">{Math.round(currentVariant.analysis?.spread || 0)} / 50</span>
                                                    </div>
                                                    <div className="h-2 bg-white/5 rounded-full overflow-hidden">
                                                        <motion.div initial={{ width: 0 }} animate={{ width: `${((currentVariant.analysis?.spread || 0) / 50) * 100}%` }} className="h-full bg-blue-500" />
                                                    </div>
                                                </div>

                                                <div className="space-y-2">
                                                    <div className="flex justify-between items-center text-sm font-bold">
                                                        <span className="text-gray-300">?ìÑ Íµ¨Ï°∞???ÑÏÑ±??/span>
                                                        <span className="text-white">{Math.round(currentVariant.analysis?.structure || 0)} / 30</span>
                                                    </div>
                                                    <div className="h-2 bg-white/5 rounded-full overflow-hidden">
                                                        <motion.div initial={{ width: 0 }} animate={{ width: `${((currentVariant.analysis?.structure || 0) / 30) * 100}%` }} className="h-full bg-green-500" />
                                                    </div>
                                                </div>

                                                <button
                                                    onClick={handleSEOOptimize}
                                                    className="w-full group relative py-4 rounded-2xl overflow-hidden transition-all active:scale-[0.98] mt-4"
                                                >
                                                    <div className="absolute inset-0 bg-gradient-to-r from-emerald-600 via-indigo-600 to-amber-600 opacity-90 transition-opacity" />
                                                    <div className="relative flex flex-col items-center justify-center gap-1">
                                                        <div className="flex items-center gap-2">
                                                            <span className="px-2 py-0.5 bg-black/30 rounded text-[11px] font-black text-white italic border border-white/20">PRO</span>
                                                            <span className="text-sm font-black text-white uppercase tracking-wider">SEO ?ùÌåê???îÏßÑ</span>
                                                            <Zap size={14} className="text-amber-400 fill-amber-400" />
                                                        </div>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                );
                            })()}
                        </ContentCard>

                        {/* Neural Loop Tracking (AutoPilot status) */}
                        {isAutoPilotActive && (
                            <motion.div
                                initial={{ opacity: 0, y: 10 }}
                                animate={{ opacity: 1, y: 0 }}
                                className="bg-indigo-600/20 border border-indigo-500/30 rounded-2xl p-4 flex items-center gap-3"
                            >
                                <div className="w-2 h-2 rounded-full bg-indigo-400 animate-ping" />
                                <div className="flex-1">
                                    <div className="text-[10px] font-black text-indigo-300 uppercase">Neural Loop Tracking</div>
                                    <div className="text-[11px] text-white font-medium">?§ÏãúÍ∞??∏Î†å??Í∏∞Ìöå ?¨Ï∞© Î£®ÌîÑ Í∞Ä??Ï§?..</div>
                                </div>
                            </motion.div>
                        )}

                        {/* AI A/B Test Report - RELOCATED TO SIDECAR (Right Column) */}
                        <ContentCard className="bg-[#0b0e14]/90 backdrop-blur-2xl border border-white/10 rounded-[28px] p-6 shadow-2xl relative">
                            <div className="flex items-center gap-3 mb-6">
                                <div className="p-2 bg-indigo-500/10 rounded-lg text-indigo-400">
                                    <Split size={20} />
                                </div>
                                <h3 className="text-xl font-black text-white">AI A/B ?åÏä§??Î¶¨Ìè¨??/h3>
                            </div>

                            <div className="space-y-6">
                                {Object.entries(displayedData.variants || {}).map(([key, variant]) => {
                                    const variantsList = Object.values(displayedData.variants || {});
                                    const maxScore = variantsList.length > 0 ? Math.max(...variantsList.map(v => v.score || 0)) : 0;
                                    const isWinner = variant.score === maxScore && maxScore > 0;

                                    return (
                                        <motion.div
                                            key={key}
                                            whileHover={{ scale: 1.02 }}
                                            onClick={() => {
                                                setActiveVariant(key);
                                                addNotification(`?ÑÎûµ ${key}Í∞Ä ?ÅÏö©?òÏóà?µÎãà??`, "success");
                                            }}
                                            className={`p-6 rounded-[32px] border transition-all cursor-pointer relative ${activeVariant === key ? 'border-indigo-500 bg-indigo-500/10' : 'border-white/5 bg-white/5 opacity-60 hover:opacity-100'}`}
                                        >
                                            {isWinner && (
                                                <div className="absolute top-0 right-6 translate-y-[-50%] bg-amber-500 text-black text-[13px] font-black px-5 py-2 rounded-full flex items-center gap-1.5 shadow-lg">
                                                    <Trophy size={14} /> ?∞Ïäπ ?ÑÎûµ
                                                </div>
                                            )}

                                            <div className="flex justify-between items-start mb-4">
                                                <span className="font-black text-indigo-400 text-[16px]">Strategy {key}</span>
                                                <div className="text-right">
                                                    {key !== 'A' ? (
                                                        <Tooltip text="Estimated CTR: AIÍ∞Ä Î∂ÑÏÑù???àÏÉÅ ?¥Î¶≠Î•†ÏûÖ?àÎã§. ?úÎ™©???§Ïõå??Í≤ΩÏüÅ?? ?åÎû´???∏Î†å?? Í∑∏Î¶¨Í≥??úÍ∞Å??Îß§Î†•?ÑÎ? Ï¢ÖÌï©?òÏó¨ 10Îß?Í±??¥ÏÉÅ??Í∞Ä???úÎ??àÏù¥???∞Ïù¥?∞Ï? ÎπÑÍµê Î∂ÑÏÑù??ÏßÄ?úÏûÖ?àÎã§." position="bottom-right">
                                                            <div className="cursor-help">
                                                                <div className="text-[11px] text-gray-500 font-black tracking-tighter uppercase">?àÏÉÅ ?¥Î¶≠Î•?(CTR)</div>
                                                                <div className="text-2xl font-black text-white leading-none mt-1">
                                                                    {variant.ctr && typeof variant.ctr === 'string' && variant.ctr.includes('.')
                                                                        ? Math.round(parseFloat(variant.ctr)) + '%'
                                                                        : variant.ctr}
                                                                </div>
                                                            </div>
                                                        </Tooltip>
                                                    ) : (
                                                        <div>
                                                            <div className="text-[11px] text-gray-500 font-black tracking-tighter uppercase">?àÏÉÅ ?¥Î¶≠Î•?(CTR)</div>
                                                            <div className="text-2xl font-black text-white leading-none mt-1">
                                                                {variant.ctr && typeof variant.ctr === 'string' && variant.ctr.includes('.')
                                                                    ? Math.round(parseFloat(variant.ctr)) + '%'
                                                                    : variant.ctr}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            <h4 className="text-[13px] font-black text-white mb-6 leading-[1.6] tracking-tight whitespace-normal break-keep">
                                                {variant.title}
                                            </h4>

                                            <div className="flex items-center gap-5">
                                                <div className="flex-1 h-2 bg-white/5 rounded-full overflow-hidden">
                                                    <motion.div
                                                        initial={{ width: 0 }}
                                                        animate={{ width: `${((variant?.score || 0) / 100) * 100}%` }}
                                                        className={`h-full shadow-[0_0_15px_rgba(99,102,241,0.5)] ${key === 'B' ? 'bg-purple-500' : 'bg-indigo-500'}`}
                                                    />
                                                </div>
                                                {key !== 'A' ? (
                                                    <Tooltip text="AI Reliability Score: ÏΩòÌÖêÏ∏†Ïùò SEO Íµ¨Ï°∞???òÏ?, Î¨∏Îß•???êÏó∞?§Îü¨?Ä(Humanization), ?†ÌîΩ???ºÍ???Î∞??ÄÍ≤??§Îîî?∏Ïä§ ?ÅÌï©?±ÏùÑ 100??ÎßåÏ†ê?ºÎ°ú ?òÏÇ∞???ÑÎ¨∏??ÏßÄ?òÏûÖ?àÎã§." position="bottom-right">
                                                        <span className="text-[14px] font-black text-gray-400 cursor-help">{Math.round(variant.score || 0)}??/span>
                                                    </Tooltip>
                                                ) : (
                                                    <span className="text-[14px] font-black text-gray-400">{Math.round(variant.score || 0)}??/span>
                                                )}
                                            </div>
                                        </motion.div>
                                    );
                                })}
                            </div>

                            <div className="mt-10 pt-8 border-t border-white/5 space-y-6">
                                <h4 className="text-[13px] font-black text-indigo-400 uppercase tracking-[0.3em] flex items-center gap-2">
                                    <Trophy size={16} /> STRATEGIC INSIGHT
                                </h4>
                                <div className="grid grid-cols-2 gap-5">
                                    <div className="p-4.5 bg-white/[0.04] rounded-[20px] border border-white/10">
                                        <div className="text-[11px] text-gray-500 font-black mb-2 uppercase tracking-wider">Strategy A Focus</div>
                                        <p className="text-[13px] text-gray-300 font-bold leading-snug">?àÏ†ï?ÅÏù∏ ?ïÎ≥¥ ?ÑÎã¨ Î¶¨Îì¨</p>
                                    </div>
                                    <div className="p-4.5 bg-white/[0.04] rounded-[20px] border border-white/10">
                                        <div className="text-[11px] text-gray-500 font-black mb-2 uppercase tracking-wider">Strategy B Focus</div>
                                        <p className="text-[13px] text-gray-300 font-bold leading-snug">?∏Í∏∞???êÍ∑π Î∞îÏù¥???πÌôî</p>
                                    </div>
                                </div>
                            </div>
                        </ContentCard>


                        {/* AI Watermark & Credit for Free Users */}
                        {user?.plan === 'free' && (
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                className="mt-12 pt-8 border-t border-white/5 flex flex-col items-center select-none"
                            >
                                <div className="flex items-center gap-2 mb-2 bg-indigo-500/5 px-4 py-2 rounded-full border border-indigo-500/10">
                                    <Zap size={14} className="text-indigo-400" />
                                    <span className="text-[9px] font-black text-white uppercase tracking-[0.3em]">Optimized by Anti-Gravity Intelligence</span>
                                </div>
                                <p className="text-[8px] text-gray-500 font-bold italic">?πÏã†???±Ïû•???ÑÌïú ?ïÎèÑ??AI ?úÏä§??/p>
                            </motion.div>
                        )}
                    </div>
                </div >

                {/* [Ultra Feature] Competitor Gap Analysis Panel (Collapsible) */}
                < AnimatePresence >
                    {showGapAnalysis && (
                        <motion.div
                            initial={{ height: 0, opacity: 0, marginBottom: 0 }}
                            animate={{ height: 'auto', opacity: 1, marginBottom: 32 }}
                            exit={{ height: 0, opacity: 0, marginBottom: 0 }}
                            className="overflow-hidden mt-8"
                        >
                            <div className="bg-rose-500/5 border border-rose-500/20 rounded-[32px] p-8 relative group/gap">
                                <div className="flex items-center justify-between mb-8">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 bg-rose-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-rose-500/30">
                                            <Sword size={24} />
                                        </div>
                                        <div>
                                            <h3 className="text-xl font-black text-white tracking-tight">?ÑÏà†??ÎπàÌãà Î∂ÑÏÑù (Competitor Recon)</h3>
                                            <p className="text-sm text-rose-400/80 font-medium tracking-tight">?ÅÏúÑ ??Çπ ÏΩòÌÖêÏ∏†Ïùò ?ÑÏà†???ΩÏ†ê???ÄÍ≤©Ìïò???∞ÏúÑ???????àÎäî ?¨Ïù∏?∏ÏûÖ?àÎã§.</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {[
                                        { title: "Í≤ΩÏüÅ???ÑÎùΩ ?ïÎ≥¥", icon: Scissors, desc: `Í∏∞Ï°¥ 1??ÏΩòÌÖêÏ∏†Îì§?Ä ${displayedData.topic}???§Ï†Ñ ?úÏö© ?¨Î?Î≥¥Îã§ ?¥Î°†?êÎßå ÏπòÏ§ë???àÏäµ?àÎã§. ?∞Î¶¨??'3Î∂??ÑÏÑ± Î£®Ìã¥'??Í∞ïÏ°∞?òÏó¨ Ï∞®Î≥Ñ?îÌï©?àÎã§.` },
                                        { title: "?¨Î¶¨???∏Î¶¨Í±?, icon: Zap, desc: `?ÄÎ∂ÄÎ∂ÑÏùò Í≤åÏãúÎ¨ºÏù¥ ?ïÎ≥¥ ?ÑÎã¨??Í∑∏ÏπòÍ≥??àÏäµ?àÎã§. ?∞Î¶¨??'ÏßÄÍ∏??πÏû• ???òÎ©¥ ?êÌï¥'?ºÎäî ?êÏã§ ?åÌîº ?¨Î¶¨Î•??êÍ∑π?òÏó¨ ?íÏ? ?¥Î¶≠Î•†ÏùÑ ?†ÎèÑ?©Îãà??` },
                                        { title: "?∞Ïù¥???¨Í∞ÅÏßÄ?Ä", icon: BarChart3, desc: `ÏµúÏã† ?§ÏãúÍ∞??µÍ≥ÑÍ∞Ä ?ÑÎùΩ??Í≤åÏãúÎ¨ºÏù¥ ÎßéÏäµ?àÎã§. AIÍ∞Ä Î∂ÑÏÑù??Í∞Ä???∞ÎÅà?∞ÎÅà???òÏπòÎ•??∏Ïö©?òÏó¨ ?ÑÎ¨∏?±Í≥º ÏµúÏã†?±ÏùÑ ?¥ÌïÑ?©Îãà??` }
                                    ].map((gap, i) => (
                                        <div key={i} className="bg-black/40 border border-white/5 p-6 rounded-2xl hover:border-rose-500/30 transition-all group/item">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="p-2 bg-rose-500/10 rounded-lg text-rose-500 group-hover/item:scale-110 transition-transform">
                                                    <gap.icon size={16} />
                                                </div>
                                                <h4 className="text-white font-bold text-sm tracking-tight">{gap.title}</h4>
                                            </div>
                                            <p className="text-xs text-gray-400 leading-relaxed font-medium">
                                                {gap.desc}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence >


                {/* Inline Detailed Analysis Center Overlay */}
                < AnimatePresence >
                    {showDetailedStats && (
                        <motion.div
                            initial={{ opacity: 0, scale: 0.95 }}
                            animate={{ opacity: 1, scale: 1 }}
                            exit={{ opacity: 0, scale: 0.95 }}
                            className="fixed inset-0 z-[200] bg-background/95 backdrop-blur-2xl p-4 lg:p-8 overflow-y-auto"
                        >
                            <div className="max-w-[1440px] mx-auto">
                                <div className="flex justify-end mb-4">
                                    <button
                                        onClick={() => setShowDetailedStats(false)}
                                        className="p-3 bg-white/5 hover:bg-white/10 rounded-2xl text-white transition-all"
                                    >
                                        <ArrowLeft size={24} className="inline mr-2" /> ?åÏïÑÍ∞ÄÍ∏?
                                    </button>
                                </div>
                                <div className="bg-surface/30 rounded-[32px] p-6 lg:p-10 border border-white/10">
                                    <h1 className="text-3xl font-black text-white mb-8 flex items-center gap-3">
                                        <BarChart3 className="text-indigo-400" size={32} /> AI ?ïÎ? Î∂ÑÏÑù Î≥¥Í≥†??
                                    </h1>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div className="space-y-6">
                                            <div className="bg-white/5 p-8 rounded-[32px] border border-white/5 relative overflow-hidden">
                                                <div className="flex justify-between items-start mb-10">
                                                    <div>
                                                        <h3 className="text-xl font-black text-white mb-2">SEO ÏµúÏ†Å???ïÎ? ÏßÑÎã®</h3>
                                                        <p className="text-sm text-gray-500">ÏΩòÌÖêÏ∏†Ïùò Í≤Ä???îÏßÑ ÏµúÏ†Å???ÅÌÉúÎ•??§ÏãúÍ∞?Î∂ÑÏÑù?©Îãà??</p>
                                                    </div>
                                                    <div className="px-4 py-2 bg-amber-500/10 border border-amber-500/20 rounded-full">
                                                        <span className="text-xs font-black text-amber-500">Í∞úÏÑ† ?ÑÏöî (Score: 69)</span>
                                                    </div>
                                                </div>

                                                <div className="flex flex-col lg:flex-row items-center gap-12">
                                                    <div className="relative w-48 h-48">
                                                        <svg className="w-full h-full transform -rotate-90">
                                                            <circle cx="96" cy="96" r="84" stroke="rgba(255,255,255,0.05)" strokeWidth="18" fill="transparent" />
                                                            <motion.circle
                                                                cx="96" cy="96" r="84"
                                                                stroke="#facc15"
                                                                strokeWidth="18"
                                                                fill="transparent"
                                                                strokeDasharray={527.7}
                                                                initial={{ strokeDashoffset: 527.7 }}
                                                                animate={{ strokeDashoffset: 527.7 - (527.7 * 69 / 100) }}
                                                                transition={{ duration: 1.5, ease: "easeOut" }}
                                                                strokeLinecap="round"
                                                            />
                                                        </svg>
                                                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                                                            <span className="text-6xl font-black text-white">69</span>
                                                            <span className="text-xs text-gray-500 font-bold mt-1 tracking-[0.2em]">SCORE</span>
                                                        </div>
                                                    </div>

                                                    <div className="flex-1 w-full space-y-6">
                                                        <h4 className="text-sm font-black text-gray-400 uppercase tracking-widest border-b border-white/10 pb-4">?ÅÏÑ∏ ?âÍ? Î¶¨Ìè¨??/h4>
                                                        <div className="space-y-5">
                                                            <div className="space-y-2.5">
                                                                <div className="flex justify-between text-sm font-bold">
                                                                    <span className="text-gray-300">?§ñ AI ?ïÏÇ∞ ?àÏ∏°</span>
                                                                    <span className="text-white">42 <span className="text-gray-600">/ 50</span></span>
                                                                </div>
                                                                <div className="h-2.5 bg-white/5 rounded-full overflow-hidden border border-white/5">
                                                                    <motion.div initial={{ width: 0 }} animate={{ width: '84%' }} className="h-full bg-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.5)]" />
                                                                </div>
                                                            </div>

                                                            <div className="space-y-2.5">
                                                                <div className="flex justify-between text-sm font-bold">
                                                                    <span className="text-gray-300">?ìÑ Íµ¨Ï°∞???ÑÏÑ±??/span>
                                                                    <span className="text-white">20 <span className="text-gray-600">/ 30</span></span>
                                                                </div>
                                                                <div className="h-2.5 bg-white/5 rounded-full overflow-hidden border border-white/5">
                                                                    <motion.div initial={{ width: 0 }} animate={{ width: '66.6%' }} className="h-full bg-green-500 shadow-[0_0_15px_rgba(34,197,94,0.5)]" />
                                                                </div>
                                                            </div>

                                                            <div className="space-y-2.5">
                                                                <div className="flex justify-between text-sm font-bold">
                                                                    <span className="text-gray-300">?î• ?∏Î†å???ÅÌï©??/span>
                                                                    <span className="text-white">7 <span className="text-gray-600">/ 20</span></span>
                                                                </div>
                                                                <div className="h-2.5 bg-white/5 rounded-full overflow-hidden border border-white/5">
                                                                    <motion.div initial={{ width: 0 }} animate={{ width: '35%' }} className="h-full bg-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.5)]" />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-white/5 p-8 rounded-[32px] border border-white/5 flex items-start gap-5">
                                                <div className="w-14 h-14 bg-amber-500/10 rounded-2xl flex items-center justify-center text-amber-500 shrink-0">
                                                    <Sparkles size={28} />
                                                </div>
                                                <div className="space-y-2">
                                                    <h4 className="text-lg font-bold text-white flex items-center gap-2">
                                                        <span className="text-xl">?í°</span> AI ÏµúÏ†Å???úÏïà
                                                    </h4>
                                                    <div className="space-y-3">
                                                        <p className="text-base text-amber-500 font-bold leading-relaxed">"?ÑÏû¨ ?úÎ™©???àÎ¨¥ Í∏∏Ïñ¥ Î™®Î∞î??Í≤Ä??Í≤∞Í≥º?êÏÑú Í∞Ä?ÖÏÑ±???®Ïñ¥Ïß????àÏäµ?àÎã§."</p>
                                                        <p className="text-sm text-gray-400 leading-relaxed font-medium">?∏Î†å???êÏàòÎ•??íÏù¥?§Î©¥ <span className="text-white">2024???úÏ¶å ?§Ïõå??/span>??<span className="text-white">ÏßÄ??Í∏∞Î∞ò ?§Ïõå??/span>Î•?Î¨∏Îã® Ï≤?Î∂ÄÎ∂ÑÏóê Î∞∞Ïπò?òÎäî Í≤ÉÏùÑ Ï∂îÏ≤ú?©Îãà??</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-white/5 p-8 rounded-[24px]">
                                            <h3 className="text-xl font-bold text-white mb-6">?§ÏãúÍ∞??†ÏûÖ ?úÎ??àÏù¥??/h3>
                                            <div className="h-64 flex items-end gap-3">
                                                {[40, 60, 45, 90, 65, 85, 100].map((h, i) => (
                                                    <motion.div
                                                        key={i}
                                                        initial={{ height: 0 }}
                                                        animate={{ height: `${h}%` }}
                                                        className="flex-1 bg-gradient-to-t from-primary to-indigo-500 rounded-t-lg"
                                                    />
                                                ))}
                                            </div>
                                            <div className="mt-6 flex justify-between text-[10px] text-gray-500 font-bold uppercase tracking-widest">
                                                <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence >

                {/* War Game Mode: Ranking Combat Modal */}
                < AnimatePresence >
                    {showWarGame && (
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            exit={{ opacity: 0 }}
                            className="fixed inset-0 z-[600] bg-black/95 backdrop-blur-3xl p-4 flex items-center justify-center"
                        >
                            <div className="max-w-4xl w-full bg-[#0a0b10] border border-white/10 rounded-[48px] overflow-hidden relative shadow-[0_0_100px_rgba(99,102,241,0.2)]">
                                <button
                                    onClick={() => setShowWarGame(false)}
                                    className="absolute top-8 right-8 p-3 bg-white/5 hover:bg-white/10 rounded-2xl text-white transition-all z-20"
                                >
                                    <X size={24} />
                                </button>

                                <div className="p-8 md:p-16 relative">
                                    <div className="text-center mb-12">
                                        <div className="inline-flex items-center gap-2 px-4 py-1.5 bg-red-500/10 border border-red-500/20 rounded-full text-red-500 text-[10px] font-black uppercase tracking-[0.3em] mb-6 animate-pulse">
                                            <Sword size={12} /> Live Ranking Combat Simulation
                                        </div>
                                        <h2 className="text-3xl md:text-5xl font-black text-white mb-4">?ÑÎûµ ?åÍ≤å???úÎ??àÏù¥??/h2>
                                        <p className="text-gray-400">?ÅÏúÑ 1% Í≤ΩÏüÅ ÏΩòÌÖêÏ∏†Ï? ?πÏã†???ÑÎûµ???§Ï†Ñ ?òÍ≤Ω?êÏÑú ÍµêÏ†Ñ?úÌÇµ?àÎã§.</p>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-center relative">
                                        <div className="space-y-6 text-center">
                                            <div className="w-24 h-24 bg-indigo-500/20 rounded-3xl mx-auto flex items-center justify-center border border-indigo-500/30 group">
                                                <Bot size={48} className="text-indigo-400 group-hover:scale-110 transition-transform" />
                                            </div>
                                            <div>
                                                <h4 className="text-lg font-black text-white italic">You (Ensemble)</h4>
                                                <p className="text-xs text-gray-500">Multimodal Strategic Optim</p>
                                            </div>
                                        </div>

                                        <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 hidden md:block">
                                            <div className="w-16 h-16 bg-white/5 border border-white/10 rounded-full flex items-center justify-center backdrop-blur-3xl shadow-2xl">
                                                <span className="text-xl font-black text-white/20 italic">VS</span>
                                            </div>
                                        </div>

                                        <div className="space-y-6 text-center">
                                            <div className="w-24 h-24 bg-red-500/10 rounded-3xl mx-auto flex items-center justify-center border border-red-500/20">
                                                <Trophy size={48} className="text-red-500/50" />
                                            </div>
                                            <div>
                                                <h4 className="text-lg font-black text-gray-500">Current Top Ranker</h4>
                                                <p className="text-xs text-gray-600">Established Authority Content</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mt-16 p-8 bg-black/40 border border-white/5 rounded-[32px] relative overflow-hidden">
                                        {warGameStatus === 'ANALYZING' && (
                                            <div className="py-12 flex flex-col items-center gap-6">
                                                <div className="flex gap-2">
                                                    {[0, 1, 2].map(i => (
                                                        <motion.div
                                                            key={i}
                                                            animate={{ height: [10, 40, 10] }}
                                                            transition={{ duration: 0.8, repeat: Infinity, delay: i * 0.2 }}
                                                            className="w-1.5 bg-indigo-500 rounded-full"
                                                        />
                                                    ))}
                                                </div>
                                                <span className="text-xs font-black text-indigo-400 uppercase tracking-widest animate-pulse">?ÅÏßÑ ?µÏã¨ ?ÑÏà† ?∞Ïù¥???§Ï∫î Ï§?..</span>
                                            </div>
                                        )}

                                        {warGameStatus === 'VOTING' && (
                                            <div className="py-6 text-center space-y-8">
                                                <div className="text-[10px] font-black text-amber-500 uppercase tracking-[0.2em]">30?∏Ïùò AI ?êÏù¥?ÑÌä∏ ?§ÏãúÍ∞?ÍµêÏ†Ñ ?¨Ìëú</div>
                                                <div className="flex flex-wrap justify-center gap-2">
                                                    {Array.from({ length: 30 }).map((_, i) => (
                                                        <motion.div
                                                            key={i}
                                                            initial={{ scale: 0 }}
                                                            animate={{ scale: 1 }}
                                                            transition={{ delay: i * 0.05 }}
                                                            className={`w-3 h-3 rounded-sm ${i < 20 ? 'bg-indigo-500 shadow-[0_0_5px_rgba(99,102,241,0.5)]' : 'bg-white/10'}`}
                                                        />
                                                    ))}
                                                </div>
                                                <p className="text-sm font-bold text-white">"?ïÎèÑ?ÅÏù∏ Í∞Ä?ÖÏÑ±Í≥??∏ÎÑ§???ÑÏà†?êÏÑú ?∞ÏúÑÎ•??êÌïòÍ≥??àÏäµ?àÎã§."</p>
                                            </div>
                                        )}

                                        {warGameStatus === 'DONE' && warGameResult && (
                                            <motion.div
                                                initial={{ opacity: 0, y: 10 }}
                                                animate={{ opacity: 1, y: 0 }}
                                                className="space-y-8"
                                            >
                                                <div className="flex justify-between items-end">
                                                    <div className="text-left">
                                                        <span className="text-[10px] text-indigo-400 font-black uppercase tracking-widest">Win Probability</span>
                                                        <div className="text-5xl md:text-6xl font-black text-white">{warGameResult.winProb}%</div>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-[10px] text-emerald-400 font-black uppercase tracking-widest">Status</span>
                                                        <div className="text-xl font-black text-emerald-400">TACTICAL VICTORY</div>
                                                    </div>
                                                </div>

                                                <div className="p-6 bg-indigo-500/10 border border-indigo-500/20 rounded-2xl">
                                                    <div className="flex items-center gap-2 mb-3">
                                                        <Signal size={14} className="text-indigo-400" />
                                                        <span className="text-[11px] font-black text-white uppercase">AI Intelligence Feedback</span>
                                                    </div>
                                                    <p className="text-sm text-gray-300 leading-relaxed italic">
                                                        "{warGameResult.feedback}"
                                                    </p>
                                                </div>

                                                <button
                                                    onClick={() => {
                                                        handleSEOOptimize();
                                                        setShowWarGame(false);
                                                    }}
                                                    className="w-full py-5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black text-sm rounded-2xl hover:shadow-[0_0_30px_rgba(99,102,241,0.4)] transition-all flex items-center justify-center gap-3 active:scale-[0.98]"
                                                >
                                                    <Sparkles size={18} /> Ï∑®ÏïΩ??Ï¶âÏãú Î≥¥Í∞ï Î∞?1???àÌôò (AI Re-generation)
                                                </button>
                                            </motion.div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence>

                {/* Preview Modal */}
                <AnimatePresence>
                    {showPreview && (
                        <PreviewModal
                            isOpen={showPreview}
                            onClose={() => setShowPreview(false)}
                            data={{
                                ...displayedData,
                                ...(displayedData.variants?.[activeVariant] || {})
                            }}
                            onConfirm={async (publishData) => {
                                const action = publishData.action || 'save';

                                if (action === 'save') {
                                    handleSave();
                                    setShowPreview(false);
                                    addNotification("ÏΩòÌÖêÏ∏†Í? Î≥¥Í??®Ïóê ?àÏ†Ñ?òÍ≤å ?Ä?•Îêò?àÏäµ?àÎã§.", "success");
                                    return;
                                }

                                // Handle Upload Flow
                                addNotification("?îÏ????∏Ïúà??Î∞úÌñâ ?∞Ïù¥?∞Î? ?ôÏäµ Ï§?..", "info");

                                // Evolution Logging before publishing
                                const newEvolution = logPerformance(Date.now(), { views: 1250, engagement: 85 });
                                setEvolution(newEvolution);

                                const publishEvent = new CustomEvent("SOCIAL_AUTO_PUBLISH", {
                                    detail: {
                                        ...publishData,
                                        timestamp: Date.now()
                                    }
                                });
                                window.dispatchEvent(publishEvent);

                                setTimeout(() => {
                                    addNotification("?∏Í≥µÏßÄ??ÏßÑÌôî ?ÑÎ£å! ?®ÌÑ¥ ?ôÏäµ?®Ïù¥ ?ÅÏäπ?àÏäµ?àÎã§.", "success");
                                    handleSave(); // Always save on upload too

                                    setShowPreview(false);
                                    if (publishData.platform === 'Naver Blog') {
                                        window.open("https://nid.naver.com/nidlogin.login?url=https://section.blog.naver.com", "_blank");
                                    } else {
                                        // Mock URL for other platforms
                                        const dummyUrl = 'https://instagram.com/p/mock_publish_id';
                                        window.open(dummyUrl, '_blank');
                                    }
                                }, 1500);
                            }}
                        />
                    )}
                </AnimatePresence>



                <div className="h-20"></div> {/* Spacer */}
            </div>


            {/* Modals */}
            <ViralSimulator
                isOpen={showSimulator}
                onClose={() => setShowSimulator(false)}
                dataA={finalData.variants?.A || finalData}
                dataB={finalData.variants?.B}
            />

            {
                showVisualAudition && (
                    <VisualAudition
                        isOpen={showVisualAudition}
                        onClose={() => setShowVisualAudition(false)}
                        topic={displayedData.topic}
                        currentImage={displayedData.bgImagePrompt ? "https://images.unsplash.com/photo-1542744173-8e7e53415bb0?auto=format&fit=crop&w=400&q=80" : null}
                    />
                )
            }

            <NeuralVideoPlayer
                isOpen={showVideoPlayer}
                onClose={() => setShowVideoPlayer(false)}
                data={{
                    ...displayedData,
                    variants: displayedData.variants || { A: { sections: [], text: "" } } // Fallback structure
                }}
            />

            {/* Functional Guide Fullscreen Overlay (Expands/Unfolds) */}
            <AnimatePresence>
                {activeGuide !== null && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 z-[200] flex items-center justify-center p-4 lg:p-12 backdrop-blur-3xl bg-black/80"
                        onClick={() => setActiveGuide(null)}
                    >
                        <motion.div
                            initial={{ scale: 0.9, y: 30, opacity: 0 }}
                            animate={{ scale: 1, y: 0, opacity: 1 }}
                            exit={{ scale: 0.9, y: 30, opacity: 0 }}
                            transition={{ type: 'spring', damping: 25, stiffness: 300 }}
                            className="relative max-w-md w-full bg-[#0b0e14] border border-white/10 rounded-[28px] overflow-hidden shadow-[0_25px_100px_rgba(0,0,0,0.8)]"
                            onClick={(e) => e.stopPropagation()}
                        >
                            {/* Close Button Inside */}
                            <div className="absolute top-4 right-4 z-10">
                                <motion.button
                                    whileHover={{ rotate: 90, scale: 1.1 }}
                                    whileTap={{ scale: 0.9 }}
                                    onClick={() => setActiveGuide(null)}
                                    className="w-8 h-8 bg-white/5 hover:bg-white/10 rounded-full flex items-center justify-center text-white border border-white/10 backdrop-blur-md transition-all"
                                >
                                    <X size={16} />
                                </motion.button>
                            </div>

                            {/* Header */}
                            <div className="p-5 border-b border-white/5 bg-gradient-to-r from-indigo-500/5 via-transparent to-transparent flex items-center gap-4">
                                <div className="w-10 h-10 bg-white/5 rounded-[14px] flex items-center justify-center border border-white/10 shadow-inner">
                                    <BookOpen size={20} className="text-indigo-400" />
                                </div>
                                <div className="space-y-0.5">
                                    <div className="flex items-center gap-2">
                                        <span className="px-1 py-0.5 bg-indigo-500/20 text-indigo-400 text-[7px] font-black uppercase rounded tracking-widest border border-indigo-500/20">System Guide</span>
                                        <h3 className="text-base font-black text-white italic tracking-tight">ÏßÄ?•Ìòï Í∏∞Îä• ?ÅÏÑ∏ Í∞Ä?¥Îìú</h3>
                                    </div>
                                    <p className="text-gray-500 font-bold uppercase tracking-[0.2em] text-[8px]">
                                        {activeGuide === 0 ? 'REVENUE INTELLIGENCE' : activeGuide === 1 ? 'LIVE CONVERSION' : 'PROFIT PORTFOLIO'}
                                    </p>
                                </div>
                            </div>

                            {/* Dynamic Data Canvas (Replaces Static Image) */}
                            <div className="p-5 overflow-y-auto max-h-[65vh] custom-scrollbar bg-black/20">
                                {(() => {
                                    const variant = displayedData.variants?.[activeVariant] || { score: 70, ctr: '5%' };
                                    const score = variant.score || 70;
                                    const ctrVal = parseFloat(variant.ctr) || 5;
                                    const monthlyTraffic = (naverData?.monthlyPcQryCnt + naverData?.monthlyMobileQryCnt || 15000);

                                    // Dynamic Calculations
                                    const avgCpc = 420; // Prime CPC for targeted content
                                    const assetValue = Math.round((monthlyTraffic * (ctrVal / 100) * avgCpc * 12) + (score * 2500));
                                    const impressions = monthlyTraffic;
                                    const clicks = Math.round(impressions * (ctrVal / 100));
                                    const conversions = Math.round(clicks * 0.052); // Improved conversion rate for high-intent
                                    const estMonthlyRevenue = conversions * 32000; // Premium conversion value

                                    if (activeGuide === 0) {
                                        return (
                                            <div className="space-y-5 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                                <div className="bg-emerald-500/10 border border-emerald-500/20 p-5 rounded-3xl relative overflow-hidden">
                                                    <Building2 className="absolute -right-4 -bottom-4 text-emerald-500/10" size={100} />
                                                    <div className="relative z-10">
                                                        <div className="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-1">Asset Valuation</div>
                                                        <h4 className="text-xl font-black text-white mb-4">?àÏÉÅ ÏΩòÌÖêÏ∏??êÏÇ∞ Í∞ÄÏπ?/h4>
                                                        <div className="text-3xl font-black text-emerald-400 tracking-tighter">
                                                            ??assetValue.toLocaleString()}
                                                        </div>
                                                        <div className="text-[10px] text-gray-500 font-bold mt-1 uppercase italic">Projected Annual Revenue Capacity</div>
                                                    </div>
                                                </div>
                                                <div className="p-4 bg-white/5 border border-white/10 rounded-2xl">
                                                    <p className="text-[12px] text-gray-400 leading-relaxed break-keep">
                                                        AI Î∂ÑÏÑù Í≤∞Í≥º, "<span className="text-white font-bold">{displayedData.topic}</span>" Ï£ºÏ†ú???íÏ? ?úÏû• ?êÏú†?®ÏùÑ ?ïÎ≥¥??Í∞Ä?•ÏÑ±???ΩÎãà?? ?ÑÏû¨ ?∞Ï∂ú???êÏÇ∞ Í∞ÄÏπòÎäî ?∞Í∞Ñ Î∞òÎ≥µ ?òÏùµÎ•?ARR)??Í∏∞Ï??ºÎ°ú ?∞Ï†ï?òÏóà?µÎãà??
                                                    </p>
                                                </div>
                                            </div>
                                        );
                                    }

                                    if (activeGuide === 1) {
                                        return (
                                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                                {[
                                                    { label: "?†Ïû¨ ?∏Ï∂ú (Traffic)", val: impressions, color: "text-blue-400", bg: "bg-blue-500/10" },
                                                    { label: "?àÏÉÅ ?¥Î¶≠ (Engagement)", val: clicks, color: "text-indigo-400", bg: "bg-indigo-500/10" },
                                                    { label: "?òÏùµ ?ÑÌôò (Revenue)", val: conversions, color: "text-emerald-400", bg: "bg-emerald-500/10" }
                                                ].map((step, i) => (
                                                    <div key={i} className={cn("p-4 rounded-2xl border border-white/5 flex items-center justify-between", step.bg)}>
                                                        <span className="text-[11px] font-black text-gray-500 uppercase">{step.label}</span>
                                                        <span className={cn("text-lg font-black", step.color)}>{step.val.toLocaleString()}</span>
                                                    </div>
                                                ))}
                                                <div className="mt-4 p-4 bg-amber-500/5 border border-amber-500/20 rounded-2xl flex gap-3">
                                                    <Zap size={16} className="text-amber-400 shrink-0" />
                                                    <p className="text-[11px] text-amber-200/70 font-medium leading-normal">
                                                        ?ÑÏû¨ CTR(<span className="text-white">{variant.ctr}</span>) Í∏∞Ï? ?úÎ??àÏù¥?òÏûÖ?àÎã§. ?§Îìú?ºÏù∏ ÏµúÏ†Å????ÏµúÎ? 25%??Ï∂îÍ? ?òÏùµ Ï¶ùÎ?Í∞Ä Í∞Ä?•Ìï©?àÎã§.
                                                    </p>
                                                </div>
                                            </div>
                                        );
                                    }

                                    return (
                                        <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                            <div className="grid grid-cols-1 gap-3">
                                                <div className="p-5 bg-white/[0.03] border border-white/10 rounded-2xl">
                                                    <div className="flex justify-between items-end mb-2">
                                                        <div>
                                                            <div className="text-[10px] text-gray-500 font-black uppercase">AdSense Est.</div>
                                                            <div className="text-xl font-black text-white">??(estMonthlyRevenue * 0.28).toLocaleString()}</div>
                                                        </div>
                                                        <div className="text-[10px] font-black text-white/30 italic">28% Share</div>
                                                    </div>
                                                    <div className="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                                                        <div className="h-full bg-blue-500 w-[28%]" />
                                                    </div>
                                                </div>
                                                <div className="p-5 bg-amber-500/10 border border-amber-500/20 rounded-2xl">
                                                    <div className="flex justify-between items-end mb-2">
                                                        <div>
                                                            <div className="text-[10px] text-amber-500/60 font-black uppercase">Affiliate Est.</div>
                                                            <div className="text-xl font-black text-amber-400">??(estMonthlyRevenue * 0.72).toLocaleString()}</div>
                                                        </div>
                                                        <div className="text-[10px] font-black text-amber-500/40 italic">72% Share</div>
                                                    </div>
                                                    <div className="w-full h-1 bg-amber-500/20 rounded-full overflow-hidden">
                                                        <div className="h-full bg-amber-500 w-[72%]" />
                                                    </div>
                                                </div>
                                            </div>
                                            <p className="text-[11px] text-center text-gray-500 italic mt-4">
                                                *?¥Îãπ ?∞Ïù¥?∞Îäî ?¨Ïö©?êÏùò ?úÎ™© ?ÑÎûµ BÎ•?Í∏∞Ï??ºÎ°ú ??ÏµúÏ†Å???¨Ìä∏?¥Î¶¨???úÏïà?ÖÎãà??
                                            </p>
                                        </div>
                                    );
                                })()}
                            </div>

                            {/* Footer Status */}
                            <div className="px-6 py-3 bg-white/[0.02] border-t border-white/5 flex items-center justify-between">
                                <div className="flex items-center gap-2 text-[8px] font-black text-gray-500 uppercase tracking-widest">
                                    <div className="w-1 h-1 rounded-full bg-emerald-500 animate-pulse" />
                                    Active Guide Protocol V1.0
                                </div>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div >
    );
};
